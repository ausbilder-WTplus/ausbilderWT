<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ausbilder-Check-in</title>
  <style>
    :root { --bg:#000; --text:#fff; --card:#111; --border:#333; --muted:#bbb; --ok:#4ade80; --warn:#facc15; --err:#f87171; }
    * { box-sizing: border-box; }
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;}
    .wrap{max-width:820px;margin:0 auto;padding:16px;}
    h1{margin:8px 0 16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;}
    video{width:100%;max-height:520px;background:#000;border-radius:12px;border:1px solid #222;}
    button{background:#fff;color:#000;border:none;border-radius:10px;padding:10px 14px;font-weight:bold;cursor:pointer;}
    button[disabled]{opacity:.6;cursor:not-allowed;}
    select{background:#000;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px;}
    .muted{color:var(--muted);} .ok{color:var(--ok);} .warn{color:var(--warn);} .err{color:var(--err);}
    pre{white-space:pre-wrap;font-size:12px;color:#ccc;background:#0c0c0c;padding:8px;border-radius:8px;border:1px solid #222;max-height:200px;overflow:auto;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Ausbilder-Check-in</h1>

  <div class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <button id="startBtn">Scan starten</button>
      <button id="stopBtn" disabled>Stopp</button>
      <select id="cameraSelect" title="Kamera auswählen"></select>
      <span id="msg" class="muted" style="margin-left:auto">Bereit</span>
    </div>
    <video id="video" autoplay playsinline muted></video>
    <details class="card" style="margin-top:12px;">
      <summary>Diagnose</summary>
      <pre id="log"></pre>
    </details>
  </div>

  <div class="card">
    <button onclick="location.href='index.html'">Zurück</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="attendance-shared.js"></script>

<!-- ZXing lokal + Fallback -->
<script>
async function ensureZXingLoaded(){
  if(window.ZXingBrowser) return;
  const sources=[
    './vendor/zxing/zxing-browser.min.js',
    'https://unpkg.com/@zxing/browser@0.1.5/umd/zxing-browser.min.js',
    'https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/zxing-browser.min.js'
  ];
  for(const src of sources){
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=()=>rej(src);document.head.appendChild(s);
      });
      if(window.ZXingBrowser) return;
    }catch(e){console.warn('ZXing Ladefehler',src);}
  }
  throw new Error('ZXing konnte nicht geladen werden.');
}
</script>

<script>
(async()=>{
  const log=(...a)=>{console.log(...a);document.getElementById('log').textContent+=a.join(' ')+'\n';};
  const {auth,db,parseQrPayload}=window._att||{};
  if(!auth||!db){alert('Firebase nicht initialisiert');return;}
  await new Promise(r=>auth.onAuthStateChanged(u=>{if(!u)location.href='index.html';else r();}));
  const msg=document.getElementById('msg'),video=document.getElementById('video'),startBtn=document.getElementById('startBtn'),stopBtn=document.getElementById('stopBtn'),cameraSelect=document.getElementById('cameraSelect');
  const setMsg=(t,c='muted')=>{msg.className=c;msg.textContent=t;}
  await ensureZXingLoaded();log('ZXing geladen:',!!window.ZXingBrowser);
  let reader,controls,running=false;
  async function listCameras(){
    const devs=await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
    cameraSelect.innerHTML='';devs.forEach((d,i)=>{const o=document.createElement('option');o.value=d.deviceId;o.textContent=d.label||'Kamera '+(i+1);cameraSelect.appendChild(o);});
  }
  await listCameras();
  async function startScan(){
    reader=new ZXingBrowser.BrowserMultiFormatReader();
    const deviceId=cameraSelect.value||undefined;
    running=true;
    controls=await reader.decodeFromVideoDevice(deviceId,video,async(res,err,ctrls)=>{
      if(res){
        const txt=res.getText();log('QR:',txt);
        const payload=parseQrPayload(txt);
        if(!payload)return setMsg('Ungültiger QR','err');
        const sref=db.collection('sessions').doc(payload.s);
        const snap=await sref.get();
        if(!snap.exists)return setMsg('Termin nicht gefunden','err');
        const s=snap.data();
        if(!s.open)return setMsg('Check-in geschlossen','err');
        if(s.qrNonce!==payload.n)return setMsg('QR veraltet','err');
        const u=auth.currentUser;
        await sref.collection('checkins').doc(u.uid).set({
          uid:u.uid,email:u.email,displayName:u.displayName,
          checkedAt:firebase.firestore.FieldValue.serverTimestamp(),
          userAgent:navigator.userAgent,nonce:payload.n
        });
        setMsg('Erfolgreich eingecheckt','ok');
      }
    });
    startBtn.disabled=true;stopBtn.disabled=false;
  }
  async function stopScan(){running=false;controls?.stop?.();reader?.reset?.();startBtn.disabled=false;stopBtn.disabled=true;}
  startBtn.onclick=startScan;stopBtn.onclick=stopScan;
})();
</script>
</body>
</html>
