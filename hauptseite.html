<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WT-Ausbilder</title>
  <style>
    :root {
      --bg:#000; --text:#fff; --accent-bg:#fff; --accent-text:#000;
      --card:#111; --border:#333; --muted:#aaa; --hover:#1a1a1a; --red:#f44;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border)}
    header img{height:60px;object-fit:contain;transition:opacity .3s ease;}
    main{display:flex;flex:1;min-height:0}
    nav{
      width:260px;background:var(--card);border-right:1px solid var(--border);
      padding:16px;display:flex;flex-direction:column;gap:8px;
      position:sticky;top:0;height:calc(100vh - 80px);overflow-y:auto;
      transition:transform .3s ease;margin-top:56px;
    }
    nav.hidden{transform:translateX(-100%)}
    nav button, nav .submenu-toggle{
      background:transparent;color:var(--text);text-align:left;border:none;
      padding:10px 14px;font-size:15px;border-radius:8px;cursor:pointer;
      display:flex;align-items:center;gap:8px;width:100%;
      transition:background .15s,transform .1s;
    }
    nav button:hover, nav .submenu-toggle:hover{background:var(--hover);transform:translateX(2px)}
    .submenu{display:none;flex-direction:column;padding-left:16px;gap:4px;margin-top:4px}
    .submenu button{font-size:14px;color:var(--muted)}
    .submenu.open{display:flex}
    #attendBtn{flex-direction:column;align-items:flex-start;line-height:1.2;font-weight:bold}
    #attendBtn span:first-child{font-size:15px}
    #attendBtn span:last-child{font-size:13px;color:var(--muted);margin-left:20px}
    .logout-container{margin-top:auto;padding:12px}
    .logout-btn{background:var(--red);color:#fff;border:none;border-radius:8px;
      padding:10px 20px;font-size:16px;font-weight:bold;cursor:pointer;width:100%}
    .logout-btn:hover{background:#d22}
    .settings-btn{background:transparent;color:var(--muted);display:none;
      align-items:center;gap:8px;justify-content:center;border:none;
      padding:10px;font-size:15px;cursor:pointer;width:100%}
    .settings-btn:hover{color:#fff;transform:rotate(5deg)}
    .content{flex:1;padding:24px;overflow:auto;display:flex;flex-direction:column;min-height:0}
    .top-actions{display:flex;justify-content:flex-end;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:16px;width:100%}
    .btn{background:var(--accent-bg);color:var(--accent-text);border:none;padding:10px 16px;border-radius:10px;font-weight:bold;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid var(--border);box-shadow:none}
    .pill{background:#0b0b0b;color:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:14px;align-self:flex-end;margin-top:auto}
    .ticker{margin-top:0;width:100%;overflow:hidden;border-radius:8px;border:1px solid var(--border);padding:10px;background:rgba(255,255,255,.05)}
    .ticker-inner{display:inline-block;white-space:nowrap;padding-left:100%;font-size:16px}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    .ticker-inner.animate{animation:scroll linear infinite}
    .calendar-wrap{margin:18px 0;width:100%;height:520px;display:none}
    .calendar-wrap iframe{width:100%;height:100%;border:none;border-radius:8px;background:#fff}
    @media(max-width:700px){nav{display:none}}
    #toggleNavBtn{position:fixed;left:16px;top:86px;z-index:1000;background:var(--accent-bg);color:var(--accent-text);border:none;border-radius:10px;padding:10px 12px;font-weight:bold;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.35)}
    #toggleNavBtn:hover{opacity:.9}
    body.nav-hidden nav{display:none}
    @media(max-width:700px){body.nav-visible nav{display:flex !important}}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal{background:#111;border:1px solid var(--border);border-radius:12px;max-width:520px;width:90%;padding:16px;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,.6)}
    .modal h3{margin-bottom:8px}
    .modal p{color:#ccc;margin-bottom:12px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end}
    .modal .btn{background:#fff;color:#000;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .modal .btn.secondary{background:#222;color:#fff;border:1px solid #444}
  </style>
</head>
<body>
<header>
  <img id="logo-left" src="logos/master/logo-left.jpg" alt="Logo links">
  <img id="logo-center" src="logos/master/logo-center.jpg" alt="Logo Mitte">
  <img id="logo-right" src="logos/master/logo-right.jpg" alt="Logo rechts">
</header>

<button id="toggleNavBtn">üß≠ Men√º</button>

<main>
  <nav id="navMenu">
    <button id="profileBtn">üë§ Mein Profil</button>

    <button class="submenu-toggle" id="trainerToggle">üìö Trainer ‚ñæ</button>
    <div class="submenu" id="trainerSub">
      <button onclick="location.href='protokollview.html'">üìì Protokoll</button>
      <button onclick="location.href='ausbilderunterlagen.html'">üìò Ausbilderunterlagen</button>
      <button id="templatesBtn">üìÇ Vorlagen</button>
      <button onclick="location.href='links.html'">üß∞ Trainingsausr√ºstung</button>
      <button onclick="location.href='spiele.html'">üé≤ Spiele</button>
      <button onclick="location.href='bilder.html'">üñºÔ∏è Bilder</button>
      <button onclick="location.href='videos.html'">üé• Videos</button>
      <button onclick="location.href='trainingszeiten.html'">üïí Trainingszeiten</button>
      <!-- HIER angepasst: kein Inline-Handler, nur ID -->
      <button id="schoolOverviewBtn">üè´ Schul√ºbersicht</button>
      <button onclick="location.href='anleitungen.html'">üìñ Anleitungen</button>
      <button onclick="location.href='checkliste.html'">‚úÖ Checkliste</button>
      <!-- ge√§ndert: kein Inline-Handler mehr -->
      <button id="snackListBtn">üçé Snackliste</button>
    </div>

    <button class="submenu-toggle" id="adminToggle" style="display:none;">üõ†Ô∏è Admin ‚ñæ</button>
    <div class="submenu" id="adminSub">
      <button id="calendarBtn">üìÖ Kalender</button>
      <button onclick="location.href='registrierung.html'">üßæ Registrierung</button>
      <button onclick="location.href='protokoll.html'">üßæ Protokoll</button>
      <button onclick="location.href='session-admin.html'">üèãÔ∏è‚Äç‚ôÇÔ∏è Ausbildertraining erstellen</button>
      <button id="planBtn">üóìÔ∏è Trainingsplan verwalten</button>
      <button id="newsTickerBtn" style="display:none;">üì∞ Newsticker</button>
      <button id="oneNoteBtn">üìì OneNote</button>
      <button id="driveBtn">üíæ Drive</button>
    </div>

    <button id="attendBtn" onclick="location.href='attend.html'">
      <span>‚úÖ Ausbildertraining</span><span>Check-In</span>
    </button>

    <div class="logout-container">
      <button class="settings-btn" id="settingsBtn">‚öôÔ∏è Einstellungen</button>
      <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
    </div>
  </nav>

  <div class="content" id="app" style="display:none">
    <div class="top-actions">
      <button class="btn ghost" id="chooseSchoolBtn" style="display:none">
        Schule: <span id="chooseSchoolLabel">MASTER</span>
      </button>
    </div>

    <div class="ticker"><div id="tickerInner" class="ticker-inner">Lade Newsticker‚Ä¶</div></div>

    <div class="calendar-wrap" id="calendarWrap">
      <iframe id="calendarFrame" src="about:blank" title="Trainingskalender"></iframe>
    </div>

    <span id="activeRolePill" class="pill" style="display:none"></span>
  </div>
</main>

<!-- Benachrichtigungs-Modal -->
<div id="protoModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="protoModalTitle">
  <div class="modal">
    <h3 id="protoModalTitle">Neues Trainingsprotokoll verf√ºgbar</h3>
    <p>Bitte aufmerksam lesen.</p>
    <div class="actions">
      <button class="btn secondary" id="btnIgnoreProto">Ignorieren</button>
      <button class="btn" id="btnOpenProto">Zum Protokoll</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

/* ---------- UI Basics ---------- */
function setupToggle(tId,sId){const t=document.getElementById(tId),s=document.getElementById(sId);if(!t||!s)return;t.onclick=()=>s.classList.toggle('open');}
setupToggle('trainerToggle','trainerSub'); setupToggle('adminToggle','adminSub');

document.getElementById('toggleNavBtn').onclick=()=>{
  const body=document.body;
  if (window.matchMedia('(max-width:700px)').matches){ body.classList.toggle('nav-visible'); }
  else { body.classList.toggle('nav-hidden'); }
};
document.getElementById('logoutBtn').onclick=async()=>{await auth.signOut();sessionStorage.clear();location.href='index.html';};
document.getElementById('profileBtn').onclick=()=>location.href='profil.html';
document.getElementById('settingsBtn').onclick=()=>location.href='einstellungen.html';

/* ---------- Header-Bilder ---------- */
function preloadAndSet(img, url, fallback) {
  if (!img) return;
  const test = new Image();
  test.onload = () => { img.src = url; img.style.opacity='1'; };
  test.onerror = () => { if (fallback) img.src = fallback; };
  img.style.opacity='0.3';
  test.src = url;
}
async function applyHeaderBySchool(school) {
  const left=document.getElementById('logo-left'),center=document.getElementById('logo-center'),right=document.getElementById('logo-right');
  const masterBase='logos/master';
  const base=(school && school.toLowerCase()!=='master')?`logos/${school.toLowerCase()}`:masterBase;
  preloadAndSet(left,`${base}/logo-left.jpg`,`${masterBase}/logo-left.jpg`);
  preloadAndSet(center,`${base}/logo-center.jpg`,`${masterBase}/logo-center.jpg`);
  preloadAndSet(right,`${base}/logo-right.jpg`,`${masterBase}/logo-right.jpg`);
}

/* ---------- Helpers ---------- */
const normalize=r=>{r=(r||'').toLowerCase();
  if(['administrator','admins','adminstrator'].includes(r))r='admin';
  if(['trainer/in','trainerin','coach'].includes(r))r='trainer';
  if(['si-fu','sifu','si fu','si‚Äêfu','si‚Äífu'].includes(r))r='si-fu';
  return r;
};
function splitSchoolsString(str){if(!str)return[];return String(str).split(/[,\n;]+/).map(s=>s.trim()).filter(Boolean);}
async function loadAccessibleSchools(key){
  const tries=[key,key?.toUpperCase(),key?.charAt(0)?.toUpperCase()+key?.slice(1)?.toLowerCase(),key?.toLowerCase()].filter(Boolean);
  for(const k of tries){
    try{
      const snap=await db.collection('Schulen').doc(k).get();
      if(snap.exists){
        const d=snap.data()||{};
        if(Array.isArray(d.School))return d.School;
        if(Array.isArray(d.schools))return d.schools;
        if(typeof d.School==='string')return splitSchoolsString(d.School);
        if(typeof d.schools==='string')return splitSchoolsString(d.schools);
      }
    }catch{}
  }
  return [];
}
async function getDocFlexible(col,key){
  const tries=[key,key?.toUpperCase(),key?.charAt(0)?.toUpperCase()+key?.slice(1)?.toLowerCase(),key?.toLowerCase()];
  for(const id of tries){try{const snap=await db.collection(col).doc(id).get();if(snap.exists)return{snap,id};}catch{}}
  return null;
}
async function setLink(id,school,fields){
  const b=document.getElementById(id);
  try{
    const r=await getDocFlexible('links',school);
    if(r){
      const d=r.snap.data()||{};
      for(const f of fields){if(d[f]){b.onclick=()=>window.open(d[f],'_blank');return;}}
    }
    b.onclick=()=>alert('Kein Link hinterlegt.');
  }catch{b.onclick=()=>alert('Fehler beim Laden.');}
}
async function setupCalendarForSchool(school){
  const r=await getDocFlexible('links',school);
  let adm=null,iframe=null;
  if(r){const d=r.snap.data()||{};adm=d.adminkalender;iframe=d.trainingskalender||d.kalender||d.calendarUrl||d.calendarURL;}
  const btn=document.getElementById('calendarBtn');
  if(btn) btn.onclick=adm?()=>window.open(adm,'_blank'):()=>alert('Kein Kalender-Link.');
  const f=document.getElementById('calendarFrame'),w=document.getElementById('calendarWrap');
  if(f&&w){if(iframe){f.src=iframe;w.style.display='block';}else{f.src='about:blank';w.style.display='none';}}
}

/* ---------- Newsticker ---------- */
let unsubscribeTicker=null;
function renderTicker(data){
  const el=document.getElementById('tickerInner');
  const text=(data&&data.text)?String(data.text).trim():'Keine Daten gefunden';
  const speed=Number.isFinite(data?.speed)?data.speed:Math.min(Math.max(text.length/6,8),30);
  const active=(data?.active!==false);
  el.textContent=active?text:'Newsticker deaktiviert';
  el.classList.add('animate');
  el.style.animationDuration=speed+'s';
}
async function startTickerListener(school){
  const schKey=String(school||'MASTER').trim().toLowerCase();
  const el=document.getElementById('tickerInner'); if(!el)return;
  if(typeof unsubscribeTicker==='function'){unsubscribeTicker();unsubscribeTicker=null;}
  const schoolDoc=db.collection('ticker').doc(schKey);
  unsubscribeTicker=schoolDoc.onSnapshot(snap=>{
    if(snap.exists){renderTicker(snap.data());}
    else{db.collection('ticker').doc('master').get().then(fb=>{renderTicker(fb.exists?fb.data():null);});}
  },_=>{db.collection('ticker').doc('master').get().then(fb=>{renderTicker(fb.exists?fb.data():null);});});
}

/* ---------- Debug-Panel ---------- */
function debugOn(){return new URLSearchParams(location.search).get('debugProto')==='1';}
function dbgPanel(){let p=document.getElementById('protoDebugPanel'); if(p) return p;
  p=document.createElement('div'); p.id='protoDebugPanel';
  p.style.cssText='position:fixed;right:10px;bottom:10px;z-index:3000;width:380px;max-height:55vh;overflow:auto;background:#111;color:#fff;border:1px solid #444;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.5);font:12px monospace';
  const head=document.createElement('div');head.style.cssText='display:flex;justify-content:space-between;align-items:center;background:#222;padding:6px 8px;position:sticky;top:0;border-bottom:1px solid #333';
  head.innerHTML='<strong>PROTO DEBUG</strong>';
  const btn=document.createElement('button'); btn.textContent='√ó'; btn.style.cssText='background:#333;color:#fff;border:1px solid #444;border-radius:6px;padding:2px 8px;cursor:pointer';
  btn.onclick=()=>{p.style.display='none';}; head.appendChild(btn);
  const body=document.createElement('div'); body.className='body'; body.style.cssText='padding:6px 8px';
  p.appendChild(head); p.appendChild(body); document.body.appendChild(p); return p;}
function dlog(msg){ if(!debugOn()) return; const p=dbgPanel(); const b=p.querySelector('.body'); const line=document.createElement('div'); line.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`; line.style.borderBottom='1px dashed #2a2a2a'; b.appendChild(line); b.scrollTop=b.scrollHeight; }

/* ---------- Protokoll-Benachrichtigung ---------- */
function ymd(d){const z=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
function todayLocal(){const d=new Date(); d.setHours(0,0,0,0); return d;}
const signedInEmail=()=>auth.currentUser?.email?.trim()||'';
const _protocolsDocIdCache=new Map();
async function resolveProtocolsDocId(schoolInput){
  const want=String(schoolInput||'').trim(); if(!want) return 'master';
  if(_protocolsDocIdCache.has(want)) return _protocolsDocIdCache.get(want);
  const variants=[want,want.toLowerCase(),want.toUpperCase(),want.charAt(0).toUpperCase()+want.slice(1).toLowerCase()].filter((v,i,a)=>a.indexOf(v)===i);
  for(const id of variants){try{const snap=await db.collection('protocols').doc(id).get(); if(snap.exists){_protocolsDocIdCache.set(want,id); return id;}}catch{}}
  const fallback=want.toLowerCase(); _protocolsDocIdCache.set(want,fallback); return fallback;
}
async function findLatestProtocolDateKeyByScanning(schoolUpper,maxDays=28){
  const docId=await resolveProtocolsDocId(schoolUpper); const base=todayLocal();
  for(let i=0;i<=maxDays;i++){
    const d=new Date(base); d.setDate(base.getDate()-i);
    const key=ymd(d);
    try{
      const snap=await db.collection('protocols').doc(docId).collection('dates').doc(key).get();
      if(snap.exists){ dlog(`proto.scan hit (docId=${docId}) = ${key}`); return key; }
    }catch(e){ dlog('proto.scan err '+(e?.code||e)); }
  }
  return null;
}
async function findLatestProtocolDateKeyUpToToday(schoolUpper){ return await findLatestProtocolDateKeyByScanning(schoolUpper,28); }
async function findLatestPastSessionDateKey(schoolUpper){
  const want=String(schoolUpper||'').trim().toLowerCase(); if(!want) return null;
  const now=new Date();
  try{
    const snap=await db.collection('sessions').orderBy('date','desc').limit(400).get();
    for(const doc of snap.docs){
      const d=doc.data()||{}; const sc=String(d.school||'').trim().toLowerCase(); const dt=d.date?.toDate?.();
      if(!dt||dt>now) continue; if(sc===want){ const key=ymd(dt); dlog(`sess.latest[client-filter] = ${key}`); return key; }
    }
  }catch(e){ dlog('sessions fallback err (no-index) '+(e?.code||e)); }
  return null;
}
async function getNewReadAckDocRef(emailRaw,schoolUpper,dateKey){
  const docId=await resolveProtocolsDocId(schoolUpper);
  return db.collection('protocols').doc(docId).collection('read').doc(dateKey).collection('byEmail').doc(emailRaw);
}
async function hasNewReadAckFor(user,schoolUpper,dateKey){
  const email=signedInEmail(); if(!email) return false;
  try{
    const ref=await getNewReadAckDocRef(email,schoolUpper,dateKey);
    const snap=await ref.get();
    if(!snap.exists){ dlog('ack: not found ('+ref.path+')'); return false; }
    const d=snap.data()||{}; const exp=d.expiresAt?.toDate?.();
    dlog(`ack: found read=${d.read} exp=${exp?exp.toLocaleString():'‚Äî'} path=${ref.path}`);
    if(d.read!==true) return false; if(exp && new Date()>=exp) return false; return true;
  }catch(e){ dlog('ack read err '+(e?.code||e)); return false;
  }
}
async function shouldShowProtocolModal(user,schoolUpper){
  const params=new URLSearchParams(location.search); if(params.get('forceProtoModal')==='1'){ dlog('FORCED'); return true; }
  const school=String(schoolUpper||'').trim(); dlog('school='+school+' email='+signedInEmail());
  let latestKey=await findLatestProtocolDateKeyUpToToday(school);
  if(!latestKey) latestKey=await findLatestPastSessionDateKey(school);
  dlog('dateKey='+(latestKey||'‚Äî')); if(!latestKey) return false;
  const okNew=await hasNewReadAckFor(user,school,latestKey); if(okNew) return false;
  dlog('SHOW modal'); return true;
}

/* ---------- Gemeinsamer Schulwahl-Dialog ---------- */
function showSchoolChooser(list, upper, baseSchool, active){
  const dlg=document.getElementById('chooseSchoolDlg');
  const sel=document.getElementById('schoolSelect');
  sel.innerHTML='';
  if(upper==='MASTER'){
    list.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;sel.appendChild(o);});
  } else {
    list.filter(n=>(n||'').toLowerCase()!==(baseSchool||'').toLowerCase())
        .forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;sel.appendChild(o);});
  }
  sel.value=active;
  dlg.style.display='flex';
}

/* ---------- Auth Flow ---------- */
auth.onAuthStateChanged(async user=>{
  if(!user){location.replace('index.html');return;}
  document.getElementById('app').style.display='block';

  let role=(sessionStorage.getItem('role')||'').toLowerCase();
  let school=(sessionStorage.getItem('school')||'').trim();
  if(!role||!school){
    const p=await db.collection('rollen').doc(user.uid).get();
    if(p.exists){const d=p.data()||{}; role=(d.role||'').toLowerCase(); school=(d.school||'').trim();
      sessionStorage.setItem('role',role); sessionStorage.setItem('school',school);}
  }
  const isAdminLike=['admin','si-fu'].includes(role);
  if(isAdminLike){ document.getElementById('adminToggle').style.display='flex'; document.getElementById('newsTickerBtn').style.display='block'; }
  document.getElementById('settingsBtn').style.display=isAdminLike?'flex':'none';
  document.getElementById('newsTickerBtn').onclick=()=>location.href='newsticker.html';

  let active=(sessionStorage.getItem('activeSchool')||school||'MASTER').trim();
  if(active.toUpperCase()==='MASTER' && school && school.toUpperCase()!=='MASTER'){
    active=school; sessionStorage.setItem('activeSchool',active.toLowerCase());
  }

  document.getElementById('activeRolePill').textContent='Rolle: '+(role||'‚Äì');
  document.getElementById('activeRolePill').style.display='inline-block';

  // ‚úÖ Trainingsplan-Button (sichtbar + Ziel setzen) 
  const planBtn=document.getElementById('planBtn');
  if(isAdminLike){
    planBtn.style.display='';
    planBtn.onclick=()=>{
      const a=(sessionStorage.getItem('activeSchool')||active||'MASTER').toLowerCase();
      location.href=`admintrainingszeiten.html?school=${encodeURIComponent(a)}`;
    };
  } else {
    planBtn.style.display='none';
  }

  const chooseBtn=document.getElementById('chooseSchoolBtn');
  const chooseLbl=document.getElementById('chooseSchoolLabel');
  chooseLbl.textContent=(active.toUpperCase()==='MASTER'?'MASTER':active);

  await applyHeaderBySchool(active);
  await setLink('oneNoteBtn',active,['onenote','OneNote','OneNoteURL']);
  await setLink('templatesBtn',active,['vorlagen']);
  await setLink('driveBtn',active,['drive']);
  await setupCalendarForSchool(active);
  startTickerListener(active);

  const upper=(school||'').toUpperCase();
  let list=[],showChooser=false;
  if(upper==='MASTER'){
    list=await loadAccessibleSchools('MASTER');
    showChooser=Array.isArray(list)&&list.length>0;
  }else{
    list=await loadAccessibleSchools(school);
    const uniq=[...new Set(list.map(s=>(s||'').toLowerCase()))];
    showChooser=uniq.filter(s=>s!==(school||'').toLowerCase()).length>0;
  }
  chooseBtn.style.display=showChooser?'inline-block':'none';

  // Dialog √∂ffnen (auch extern nutzbar)
  chooseBtn.onclick=()=>{ if(showChooser){ showSchoolChooser(list, upper, school, active); } };

  // üö¶ Snackliste-Guard: erst √∂ffnen, wenn konkrete Schule gew√§hlt ist
  const snackBtn=document.getElementById('snackListBtn');
  snackBtn.onclick=()=>{
    const base=(sessionStorage.getItem('school')||school||'').trim();
    const chosen=(sessionStorage.getItem('activeSchool')||active||'').trim();
    const needChoice = showChooser && (
      !chosen ||
      chosen.toUpperCase()==='MASTER' ||
      chosen.toLowerCase()===base.toLowerCase() // noch auf Gruppen-/Basiswert
    );
    if(needChoice){
      alert('Bitte zuerst eine Schule ausw√§hlen.');
      showSchoolChooser(list, upper, base, chosen || ''); // Dialog anzeigen
      return;
    }
    // Alles gut: mit gew√§hlter Schule weiter
    location.href = `snackliste.html?school=${encodeURIComponent(chosen.toLowerCase())}`;
  };

  // üè´ Schul√ºbersicht abh√§ngig von aktiver Schule √∂ffnen
  const schoolOverviewBtn = document.getElementById('schoolOverviewBtn');
  if (schoolOverviewBtn) {
    schoolOverviewBtn.onclick = () => {
      const baseSchool = (sessionStorage.getItem('school') || school || '').trim();
      let chosen = (sessionStorage.getItem('activeSchool') || active || baseSchool || 'master').trim();

      // Falls noch MASTER aktiv, aber eine echte Schule hinterlegt ist ‚Üí Basis-Schule nutzen
      if (chosen.toUpperCase() === 'MASTER' && baseSchool) {
        chosen = baseSchool;
      }

      const folder = chosen.toLowerCase();
      // Ziel: "<schule>/schuluebersicht/schuluebersicht.html"
      const target = `${folder}/schuluebersicht/schuluebersicht.html`;
      location.href = target;
    };
  }

  try{
    const show=await shouldShowProtocolModal(user,active);
    document.getElementById('protoModal').style.display=show?'flex':'none';
  }catch(e){ dlog('check err '+(e?.code||e)); document.getElementById('protoModal').style.display='none'; }
});

/* ---------- Buttons & Dialogs ---------- */
document.addEventListener('click',async e=>{
  const b=e.target.closest('button'); if(!b) return;

  if(b.id==='dlgCancel'){ document.getElementById('chooseSchoolDlg').style.display='none'; }
  if(b.id==='dlgApply'){
    const s=document.getElementById('schoolSelect'); const v=s.value||'MASTER';
    sessionStorage.setItem('activeSchool',v.toLowerCase());
    document.getElementById('chooseSchoolLabel').textContent=(v.toUpperCase()==='MASTER'?'MASTER':v);
    await applyHeaderBySchool(v);
    await setLink('oneNoteBtn',v,['onenote','OneNote','OneNoteURL']);
    await setLink('templatesBtn',v,['vorlagen']);
    await setLink('driveBtn',v,['drive']);
    await setupCalendarForSchool(v);
    document.getElementById('chooseSchoolDlg').style.display='none';
    startTickerListener(v);

    // ‚úÖ Plan-Button nach Schulwechsel aktualisieren
    const planBtn=document.getElementById('planBtn');
    const roleNow=(sessionStorage.getItem('role')||'').toLowerCase();
    if(['admin','si-fu'].includes(roleNow)){
      planBtn.style.display='';
      planBtn.onclick=()=>{
        const a=(sessionStorage.getItem('activeSchool')||v||'MASTER').toLowerCase();
        location.href=`admintrainingszeiten.html?school=${encodeURIComponent(a)}`;
      };
    } else planBtn.style.display='none';
  }

  if(b.id==='btnOpenProto'){ location.href='protokollview.html'; }
  if(b.id==='btnIgnoreProto'){ document.getElementById('protoModal').style.display='none'; }
});
</script>

<!-- Schulwahl-Dialog -->
<div class="scope-dialog-backdrop" id="chooseSchoolDlg"
  style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1999">
  <div class="scope-dialog" role="dialog" aria-modal="true" aria-labelledby="scopeTitle"
    style="width:92%;max-width:460px;background:#111;color:#fff;border:1px solid #333;border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.6);padding:16px;">
    <h3 id="scopeTitle" style="margin:0 0 10px;font-size:20px;">Schule w√§hlen</h3>
    <select id="schoolSelect" style="width:100%;background:#000;color:#fff;border:1px solid #333;border-radius:10px;padding:10px 12px"></select>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
      <button id="dlgCancel" class="ghost">Abbrechen</button>
      <button id="dlgApply" class="btn">√úbernehmen</button>
    </div>
  </div>
</div>
</body>
</html>
