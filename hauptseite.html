<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WT-Ausbilder</title>
  <style>
    :root {
      --bg:#000; --text:#fff; --accent-bg:#fff; --accent-text:#000;
      --card:#111; --border:#333; --muted:#aaa; --hover:#1a1a1a; --red:#f44;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border)}
    header img{height:60px}
    main{display:flex;flex:1;min-height:0}

    /* ====== NAVIGATION ====== */
    nav{
      width:260px;background:var(--card);border-right:1px solid var(--border);
      padding:16px;display:flex;flex-direction:column;gap:8px;
      position:sticky;top:0;height:calc(100vh - 80px);overflow-y:auto;
    }
    nav button, nav .submenu-toggle{
      background:transparent;color:var(--text);text-align:left;border:none;
      padding:10px 14px;font-size:15px;border-radius:8px;cursor:pointer;
      display:flex;align-items:center;gap:8px;width:100%;
      transition:background .15s,transform .1s;
    }
    nav button:hover, nav .submenu-toggle:hover{
      background:var(--hover);transform:translateX(2px);
    }
    .submenu{
      display:none;flex-direction:column;padding-left:16px;gap:4px;margin-top:4px;
    }
    .submenu button{font-size:14px;color:var(--muted);}
    .submenu.open{display:flex;}

    /* Mehrzeiliger Button fÃ¼r Check-In */
    #attendBtn {
      flex-direction:column;
      align-items:flex-start;
      line-height:1.2;
      font-weight:bold;
    }
    #attendBtn span:first-child { font-size:15px; }
    #attendBtn span:last-child {
      font-size:13px;
      color:var(--muted);
      margin-left:20px;
    }

    .logout-container{margin-top:auto;padding:12px;}
    .logout-btn{
      background:var(--red);color:#fff;border:none;border-radius:8px;
      padding:10px 20px;font-size:16px;font-weight:bold;cursor:pointer;width:100%;
    }
    .logout-btn:hover{background:#d22;}
    .settings-btn{
      background:transparent;color:var(--muted);
      display:flex;align-items:center;gap:8px;justify-content:center;
      border:none;padding:10px;font-size:15px;cursor:pointer;width:100%;
    }
    .settings-btn:hover{color:#fff;transform:rotate(5deg);}

    /* ====== CONTENT ====== */
    .content{flex:1;padding:24px;overflow:auto;display:flex;flex-direction:column;min-height:0;}
    .top-actions{
      display:flex;justify-content:flex-end;align-items:center;
      flex-wrap:wrap;gap:10px;margin-bottom:16px;width:100%;
    }
    .btn{background:var(--accent-bg);color:var(--accent-text);border:none;padding:10px 16px;border-radius:10px;font-weight:bold;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid var(--border);box-shadow:none}
    .pill{
      background:#0b0b0b;color:#fff;border:1px solid var(--border);
      border-radius:999px;padding:8px 12px;font-size:14px;
      align-self:flex-end;margin-top:auto;
    }

    .ticker{margin-top:0;width:100%;overflow:hidden;border-radius:8px;border:1px solid var(--border);padding:10px;background:rgba(255,255,255,.05)}
    .ticker-inner{display:inline-block;white-space:nowrap;padding-left:100%;font-size:16px}
    @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    .ticker-inner.animate{animation:scroll linear infinite;animation-duration:12s}

    .calendar-wrap{margin:18px 0;width:100%;height:520px;display:none}
    .calendar-wrap iframe{width:100%;height:100%;border:none;border-radius:8px;background:#fff}

 
  </style>
</head>
<body>
<header>
  <img id="logo-left" src="pluslogo.png" alt="Logo links">
  <img id="logo-center" src="faust.jpg" alt="Logo Mitte">
  <img id="logo-right" src="melsungen.jpg" alt="Logo rechts">
</header>

<main>
  <!-- ===== NAVIGATION ===== -->
  <nav id="navMenu">
    <button id="profileBtn">ğŸ‘¤ Mein Profil</button>

    <button class="submenu-toggle" id="trainerToggle">ğŸ“š Trainer â–¾</button>
    <div class="submenu" id="trainerSub">
      <button id="oneNoteBtn">ğŸ““ OneNote</button>
      <button id="templatesBtn">ğŸ“‚ Vorlagen</button>
      <button id="driveBtn">ğŸ’¾ Drive</button>
      <button onclick="location.href='links.html'">ğŸ§° TrainingsausrÃ¼stung</button>
      <button onclick="location.href='spiele.html'">ğŸ² Spiele</button>
      <button onclick="location.href='bilder.html'">ğŸ–¼ï¸ Bilder</button>
      <button onclick="location.href='videos.html'">ğŸ¥ Videos</button>
      <button onclick="location.href='trainingszeiten.html'">ğŸ•’ Trainingszeiten</button>
      <button onclick="location.href='schuluebersicht.html'">ğŸ« SchulÃ¼bersicht</button>
      <button onclick="location.href='anleitungen.html'">ğŸ“– Anleitungen</button>
      <button onclick="location.href='checkliste.html'">âœ… Checkliste</button>
    </div>

    <button class="submenu-toggle" id="adminToggle" style="display:none;">ğŸ› ï¸ Admin â–¾</button>
    <div class="submenu" id="adminSub">
      <button id="calendarBtn">ğŸ“… Kalender</button>
      <button onclick="location.href='registrierung.html'">ğŸ§¾ Registrierung</button>
      <button onclick="location.href='session-admin.html'">ğŸ‹ï¸â€â™‚ï¸ Trainingstermin erstellen</button>
    </div>

    <!-- Zweizeiliger Check-In Button -->
    <button id="attendBtn" onclick="location.href='attend.html'">
      <span>âœ… Ausbildertraining</span>
      <span>Check-In</span>
    </button>

    <button onclick="location.href='passwort-aendern.html'">ğŸ”‘ Passwort Ã¤ndern</button>

    <div class="logout-container">
      <button class="settings-btn" id="settingsBtn">âš™ï¸ Einstellungen</button>
      <button class="logout-btn" id="logoutBtn">ğŸšª Logout</button>
    </div>
  </nav>

  <!-- ===== CONTENT ===== -->
  <div class="content" id="app" style="display:none">
    <!-- Rechts oben: Schule wÃ¤hlen -->
    <div class="top-actions">
      <button class="btn ghost" id="chooseSchoolBtn" style="display:none">
        Schule: <span id="chooseSchoolLabel">MASTER</span>
      </button>
    </div>

    <!-- Nur noch der Newsticker -->
    <div class="ticker"><div id="tickerInner" class="ticker-inner">Lade Newstickerâ€¦</div></div>

    <!-- Kalender -->
    <div class="calendar-wrap" id="calendarWrap">
      <iframe id="calendarFrame" src="about:blank" title="Trainingskalender"></iframe>
    </div>

    <!-- Rollenanzeige unten rechts -->
    <span id="activeRolePill" class="pill" style="display:none"></span>
  </div>
</main>

<!-- ===== Firebase & Skript ===== -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

/* SubmenÃ¼-Toggle */
function setupToggle(tId,sId){const t=document.getElementById(tId),s=document.getElementById(sId);if(!t||!s)return;t.onclick=()=>s.classList.toggle('open');}
setupToggle('trainerToggle','trainerSub');setupToggle('adminToggle','adminSub');

document.getElementById('logoutBtn').onclick=async()=>{await auth.signOut();sessionStorage.clear();location.href='index.html';};
document.getElementById('profileBtn').onclick=()=>location.href='profil.html';
document.getElementById('settingsBtn').onclick=()=>location.href='einstellungen.html';

function preloadAndSet(img,u){const t=new Image();t.onload=()=>img.src=u;t.src=u;}
function applyHeaderBySchool(s){const h=document.querySelector('header');h.innerHTML=`<img id="logo-left" src="pluslogo.png"><img id="logo-center" src="faust.jpg"><img id="logo-right" src="melsungen.jpg">`;if(!s||s.toLowerCase()==='master')return;const b=`logos/${s.toLowerCase()}`;preloadAndSet(document.getElementById('logo-left'),`${b}/logo-left.jpg`);preloadAndSet(document.getElementById('logo-center'),`${b}/logo-center.jpg`);preloadAndSet(document.getElementById('logo-right'),`${b}/logo-right.jpg`);}
const normalize=r=>{r=(r||'').toLowerCase();if(['administrator','admins','adminstrator'].includes(r))r='admin';if(['trainer/in','trainerin','coach'].includes(r))r='trainer';if(['si-fu','sifu','si fu','siâ€fu','siâ€’fu'].includes(r))r='si-fu';return r;};
function splitSchoolsString(str){if(!str)return[];return String(str).split(/[,\n;]+/).map(s=>s.trim()).filter(Boolean);}
async function loadAccessibleSchools(key){const tries=[key,key?.toUpperCase(),key?.charAt(0)?.toUpperCase()+key?.slice(1)?.toLowerCase(),key?.toLowerCase()].filter(Boolean);const seen=new Set();for(const k of tries){if(seen.has(k))continue;seen.add(k);try{const snap=await db.collection('Schulen').doc(k).get();if(snap.exists){const d=snap.data()||{};if(Array.isArray(d.School))return d.School.map(String).map(s=>s.trim()).filter(Boolean);if(typeof d.School==='string')return splitSchoolsString(d.School);if(Array.isArray(d.schools))return d.schools.map(String).map(s=>s.trim()).filter(Boolean);if(typeof d.schools==='string')return splitSchoolsString(d.schools);return[];}}catch(e){console.warn('loadAccessibleSchools error',e);}}return[];}
async function getDocFlexible(col,key){const base=(key??'').trim();const tries=[base,base.toUpperCase(),base.charAt(0).toUpperCase()+base.slice(1).toLowerCase(),base.toLowerCase()];for(const id of tries){try{const snap=await db.collection(col).doc(id).get();if(snap.exists)return{snap,id};}catch(e){}}return null;}
async function setLink(id,school,fields){const b=document.getElementById(id);try{const r=await getDocFlexible('links',school);if(r){const d=r.snap.data()||{};for(const f of fields){if(d[f]){b.onclick=()=>window.open(d[f],'_blank');return;}}}b.onclick=()=>alert('Kein Link hinterlegt.');}catch(e){b.onclick=()=>alert('Fehler beim Laden.');}}
async function setupCalendarForSchool(school){const r=await getDocFlexible('links',school);let adm=null,iframe=null;if(r){const d=r.snap.data()||{};adm=d.adminkalender;iframe=d.trainingskalender||d.kalender||d.calendarUrl||d.calendarURL;}const btn=document.getElementById('calendarBtn');btn.onclick=adm?()=>window.open(adm,'_blank'):()=>alert('Kein Kalender-Link.');const f=document.getElementById('calendarFrame'),w=document.getElementById('calendarWrap');if(iframe){f.src=iframe;w.style.display='block';}else{f.src='about:blank';w.style.display='none';}}
auth.onAuthStateChanged(async user=>{
  if(!user){location.replace('index.html');return;}
  document.getElementById('app').style.display='block';
  let role=normalize(sessionStorage.getItem('role')),school=(sessionStorage.getItem('school')||'').trim();
  if(!role||!school){const p=await db.collection('rollen').doc(user.uid).get();if(p.exists){const d=p.data();role=normalize(d.role);school=(d.school||'').trim();sessionStorage.setItem('role',role);sessionStorage.setItem('school',school);}}
  const pill=document.getElementById('activeRolePill');pill.textContent='Rolle: '+(role||'â€“');pill.style.display='inline-block';
  if(['admin','si-fu'].includes(role))document.getElementById('adminToggle').style.display='flex';
  let active=(sessionStorage.getItem('activeSchool')||school||'MASTER').trim();
  const chooseBtn=document.getElementById('chooseSchoolBtn'),chooseLbl=document.getElementById('chooseSchoolLabel');
  const upper=(school||'').toUpperCase();let list=[];
  if(upper==='MASTER'){list=await loadAccessibleSchools('MASTER');chooseBtn.style.display='inline-block';}
  else{list=await loadAccessibleSchools(school);if(list.length>0){chooseBtn.style.display='inline-block';if(!active||active.toLowerCase()===school.toLowerCase()){active=list[0]||active;sessionStorage.setItem('activeSchool',active.toLowerCase());}}else{chooseBtn.style.display='none';active=school;}}
  chooseLbl.textContent=(active.toUpperCase()==='MASTER'?'MASTER':active);applyHeaderBySchool(active);
  await setLink('oneNoteBtn',active,['onenote','OneNote','OneNoteURL']);
  await setLink('templatesBtn',active,['vorlagen']);
  await setLink('driveBtn',active,['drive']);
  await setupCalendarForSchool(active);
  chooseBtn.onclick=()=>{const dlg=document.getElementById('chooseSchoolDlg'),sel=document.getElementById('schoolSelect');sel.innerHTML='';if(upper==='MASTER'){const o=document.createElement('option');o.value='MASTER';o.textContent='MASTER (alle)';sel.appendChild(o);}list.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;sel.appendChild(o);});const want=(sessionStorage.getItem('activeSchool')||active||'MASTER')||'';sel.value=(want.toUpperCase()==='MASTER')?'MASTER':want;dlg.style.display='flex';};
});
document.addEventListener('click',async e=>{const b=e.target.closest('button');if(!b)return;if(b.id==='dlgCancel')document.getElementById('chooseSchoolDlg').style.display='none';if(b.id==='dlgApply'){const s=document.getElementById('schoolSelect'),v=s.value||'MASTER';sessionStorage.setItem('activeSchool',v.toLowerCase());document.getElementById('chooseSchoolLabel').textContent=(v.toUpperCase()==='MASTER'?'MASTER':v);applyHeaderBySchool(v);await setLink('oneNoteBtn',v,['onenote','OneNote','OneNoteURL']);await setLink('templatesBtn',v,['vorlagen']);await setLink('driveBtn',v,['drive']);await setupCalendarForSchool(v);document.getElementById('chooseSchoolDlg').style.display='none';}});
const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vTqv9vVFE1kHZdb48JLBpUd3uwsin78PVjCLEGDmUztI78RYSPstjAxUi0uuwV-34fe91G4SfuQHGsl/pub?output=csv";
(async()=>{try{const r=await fetch(csvUrl);const t=await r.text();const f=t.trim().split(/\r?\n/)[0]||'Keine Daten gefunden';const el=document.getElementById('tickerInner');el.textContent=f;const d=Math.min(Math.max(f.length/6,8),30);el.classList.add('animate');el.style.animationDuration=d+'s';}catch(e){document.getElementById('tickerInner').textContent='Fehler beim Laden';}})();
</script>

<!-- ===== Schulwahl-Dialog ===== -->
<div class="scope-dialog-backdrop" id="chooseSchoolDlg" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:999">
  <div class="scope-dialog" role="dialog" aria-modal="true" aria-labelledby="scopeTitle" style="width:92%;max-width:460px;background:#111;color:#fff;border:1px solid #333;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.6);padding:16px;">
    <h3 id="scopeTitle" style="margin:0 0 10px;font-size:20px;">Schule wÃ¤hlen</h3>
    <select id="schoolSelect" class="scope-select" style="width:100%;background:#000;color:#fff;border:1px solid #333;border-radius:10px;padding:10px 12px"></select>
    <div class="scope-actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
      <button id="dlgCancel" class="ghost">Abbrechen</button>
      <button id="dlgApply" class="btn">Ãœbernehmen</button>
    </div>
  </div>
</div>
</body>
</html>
