<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mein Profil</title>
  <style>
    :root { --bg:#000; --text:#fff; --card:#111; --border:#333; --muted:#bbb; --ok:#4ade80; --err:#f87171; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: Arial, Helvetica, sans-serif; }
    .wrap { max-width:980px; margin:0 auto; padding:16px; }
    h1 { margin:8px 0 16px; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .card { flex:1 1 300px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; }
    .card h3 { margin:0 0 10px; }
    .kv { display:grid; grid-template-columns: 180px 1fr; gap:8px 12px; }
    .kv div { padding:4px 0; }
    .muted { color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    button { background:#fff; color:#000; border:none; border-radius:10px; padding:8px 12px; font-weight:bold; cursor:pointer; }
    button.ghost { background:transparent; color:var(--muted); border:1px solid var(--border); }
    .form { display:grid; gap:10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:14px; color:var(--muted); }
    .field input {
      background:#000; color:#fff; border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .hint { font-size:13px; color:var(--muted); }
    .status { margin-top:8px; min-height:18px; }
    .ok { color:var(--ok); } .err { color:var(--err); }
  </style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
    <h1>ðŸ‘¤ Mein Profil</h1>
    <div class="actions">
      <button onclick="location.href='hauptseite.html'">Zur Hauptseite</button>
      <button id="refreshBtn" class="ghost">Aktualisieren</button>
    </div>
  </div>

  <div class="row">
    <!-- Auth-Profil -->
    <div class="card">
      <h3>Login / Authentication</h3>
      <div class="kv">
        <div class="muted">UID</div>             <div class="mono" id="uid">â€“</div>
        <div class="muted">E-Mail</div>          <div class="mono" id="email">â€“</div>
        <div class="muted">Anzeigename</div>     <div id="displayName">â€“</div>
        <div class="muted">Erstellt am</div>     <div id="created">â€“</div>
        <div class="muted">Letzte Anmeldung</div><div id="lastLogin">â€“</div>
        <div class="muted">Rolle</div>           <div id="role">â€“</div>
        <div class="muted">Schule</div>          <div id="school">â€“</div>
      </div>
      <!-- Kopier-Buttons entfernt -->
    </div>
  </div>

  <!-- Passwort Ã¤ndern -->
  <div class="card" style="margin-top:16px;">
    <h3>ðŸ”‘ Passwort Ã¤ndern</h3>
    <div id="pwInfo" class="hint" style="margin-bottom:8px;"></div>
    <div id="pwForm" class="form" style="display:none;">
      <div class="field">
        <label for="oldPw">Aktuelles Passwort</label>
        <input id="oldPw" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
      </div>
      <div class="field">
        <label for="newPw">Neues Passwort</label>
        <input id="newPw" type="password" autocomplete="new-password" placeholder="mind. 6 Zeichen" />
      </div>
      <div class="field">
        <label for="newPw2">Neues Passwort (Wiederholung)</label>
        <input id="newPw2" type="password" autocomplete="new-password" placeholder="nochmal eingeben" />
      </div>
      <div class="actions" style="margin-top:4px;">
        <button id="changePwBtn">Passwort Ã¤ndern</button>
        <button id="sendResetBtn" class="ghost">Reset-Link per E-Mail senden</button>
      </div>
      <div id="pwStatus" class="status"></div>
    </div>
    <div id="pwResetOnly" style="display:none;">
      <div class="hint" style="margin-bottom:8px;">
        Dein Konto nutzt derzeit keinen E-Mail/Passwort-Login (z. B. Google/Apple). Du kannst dir einen
        <b>Passwort-Reset-Link</b> an deine E-Mail senden, um ein Passwort zu setzen.
      </div>
      <div class="actions">
        <button id="sendResetOnlyBtn">Reset-Link per E-Mail senden</button>
      </div>
      <div id="pwStatusAlt" class="status"></div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
(function(){
  if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // Elemente
  const uidEl = document.getElementById('uid');
  const emailEl = document.getElementById('email');
  const displayNameEl = document.getElementById('displayName');
  const createdEl = document.getElementById('created');
  const lastLoginEl = document.getElementById('lastLogin');
  const roleEl = document.getElementById('role');
  const schoolEl = document.getElementById('school');

  // Passwort-UI
  const pwInfo = document.getElementById('pwInfo');
  const pwForm = document.getElementById('pwForm');
  const pwResetOnly = document.getElementById('pwResetOnly');
  const oldPw = document.getElementById('oldPw');
  const newPw = document.getElementById('newPw');
  const newPw2 = document.getElementById('newPw2');
  const changePwBtn = document.getElementById('changePwBtn');
  const sendResetBtn = document.getElementById('sendResetBtn');
  const sendResetOnlyBtn = document.getElementById('sendResetOnlyBtn');
  const pwStatus = document.getElementById('pwStatus');
  const pwStatusAlt = document.getElementById('pwStatusAlt');

  function setKV(el, val){ el.textContent = (val===undefined || val===null || val==='') ? 'â€“' : String(val); }
  function hasPasswordProvider(u){ return (u.providerData||[]).some(p => p.providerId === 'password'); }
  function setStatus(el, text, ok=false){
    el.textContent = text || '';
    el.className = 'status ' + (ok ? 'ok' : (text ? 'err' : ''));
  }

  async function loadRoleSchool(uid){
    try{
      const snap = await db.collection('rollen').doc(uid).get();
      if (snap.exists){
        const data = snap.data() || {};
        setKV(roleEl, data.role || data.rolle || 'â€“');
        setKV(schoolEl, (data.school || data.schule || '').toString().trim() || 'â€“');
      }else{
        setKV(roleEl, 'â€“');
        setKV(schoolEl, 'â€“');
      }
    }catch(e){
      setKV(roleEl, 'â€“');
      setKV(schoolEl, 'â€“');
    }
  }

  async function loadAll(){
    const u = auth.currentUser;
    if (!u) { location.replace('index.html'); return; }

    // Auth-Infos
    setKV(uidEl, u.uid);
    setKV(emailEl, u.email);
    setKV(displayNameEl, u.displayName || '');
    setKV(createdEl, u.metadata?.creationTime || '');
    setKV(lastLoginEl, u.metadata?.lastSignInTime || '');

    // Rolle / Schule aus Firestore
    await loadRoleSchool(u.uid);

    // Passwort-Form je nach Provider
    if (hasPasswordProvider(u)){
      pwInfo.textContent = 'Hier kannst du dein Passwort direkt Ã¤ndern. Aus SicherheitsgrÃ¼nden ist dein aktuelles Passwort erforderlich.';
      pwForm.style.display = 'grid';
      pwResetOnly.style.display = 'none';
    }else{
      pwInfo.textContent = 'Dein Login verwendet keinen Passwort-Provider (z. B. Google/Apple). Du kannst dir einen Reset-Link senden lassen, um ein Passwort zu setzen.';
      pwForm.style.display = 'none';
      pwResetOnly.style.display = 'block';
    }
  }

  // Events
  document.getElementById('refreshBtn').onclick = loadAll;

  // Passwort Ã¤ndern
  changePwBtn?.addEventListener('click', async ()=>{
    setStatus(pwStatus, '');
    const u = auth.currentUser;
    if (!u) { setStatus(pwStatus, 'Nicht eingeloggt.'); return; }

    const oldVal = oldPw.value.trim();
    const newVal = newPw.value.trim();
    const newVal2 = newPw2.value.trim();

    if (!oldVal){ setStatus(pwStatus, 'Bitte aktuelles Passwort eingeben.'); return; }
    if (newVal.length < 6){ setStatus(pwStatus, 'Neues Passwort muss mindestens 6 Zeichen haben.'); return; }
    if (newVal !== newVal2){ setStatus(pwStatus, 'Die neuen PasswÃ¶rter stimmen nicht Ã¼berein.'); return; }

    try{
      const cred = firebase.auth.EmailAuthProvider.credential(u.email, oldVal);
      await u.reauthenticateWithCredential(cred);
      await u.updatePassword(newVal);
      oldPw.value = newPw.value = newPw2.value = '';
      setStatus(pwStatus, 'Passwort erfolgreich geÃ¤ndert.', true);
    }catch(e){
      const code = e?.code || '';
      let msg = e?.message || String(e);
      if (code === 'auth/wrong-password') msg = 'Das aktuelle Passwort ist falsch.';
      if (code === 'auth/too-many-requests') msg = 'Zu viele Versuche. Bitte spÃ¤ter erneut probieren.';
      if (code === 'auth/requires-recent-login') msg = 'Sicherheitsbedingt bitte neu einloggen und erneut versuchen.';
      setStatus(pwStatus, msg);
    }
  });

  // Reset-Link senden
  async function sendResetEmailCommon(targetEl){
    setStatus(targetEl, '');
    const u = auth.currentUser;
    if (!u || !u.email){ setStatus(targetEl, 'Kein eingeloggter Nutzer oder keine E-Mail gefunden.'); return; }
    try{
      await auth.sendPasswordResetEmail(u.email);
      setStatus(targetEl, 'Reset-Link wurde an ' + u.email + ' gesendet.', true);
    }catch(e){
      setStatus(targetEl, e?.message || String(e));
    }
  }
  sendResetBtn?.addEventListener('click', ()=>sendResetEmailCommon(pwStatus));
  sendResetOnlyBtn?.addEventListener('click', ()=>sendResetEmailCommon(pwStatusAlt));

  // Auth-Flow
  auth.onAuthStateChanged(u => { if (!u) location.replace('index.html'); else loadAll(); });
})();
</script>
</body>
</html>
