<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snackliste</title>
  <style>
    :root { --bg:#000; --text:#fff; --card:#fff; --muted:#888; }
    * { box-sizing:border-box; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: Arial, Helvetica, sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
      -webkit-font-smoothing:antialiased;
    }
    .header{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 16px; gap:12px; border-bottom:1px solid rgba(255,255,255,.12);
    }
    .header img{ height:80px; width:auto; object-fit:contain; transition:opacity .3s ease; }
    @media (max-width:750px){ .header img{ height:44px; } }
    @media (max-width:480px){ .header img{ height:40px; } }

    .wrap{ flex:1; display:flex; flex-direction:column; align-items:center; gap:16px; padding:16px; }
    .toolbar{ width:95%; max-width:960px; display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:6px; }
    .toolbar .info { color:var(--muted); }

    .add-box{
      width:95%; max-width:960px; background:var(--card); color:#111;
      border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.35);
      padding:12px; display:flex; flex-wrap:wrap; align-items:center; gap:10px;
    }
    .add-box label{ font-weight:bold; }
    .add-box input[type="date"]{ padding:10px; border:1px solid #ddd; border-radius:10px; }
    .btn {
      background:#000; color:#fff; border:none; border-radius:12px;
      padding:10px 14px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.35);
    }
    .btn.secondary { background:#666; }
    .btn[disabled]{ opacity:.6; cursor:default; }

    .msg{
      width:95%; max-width:960px; min-height:40px; background:#fff; color:#111;
      border-radius:8px; display:flex; align-items:center; padding:8px 10px;
    }
    .msg.ok{ background:#e7ffe7; }

    .list{ width:95%; max-width:960px; display:grid; gap:12px; grid-template-columns: 1fr; }
    .card{
      background:var(--card); color:#111; border-radius:12px;
      box-shadow:0 4px 16px rgba(0,0,0,.35); padding:14px;
      display:grid; grid-template-columns: 1.2fr 1fr auto; gap:12px; align-items:center;
    }
    .date { font-weight:bold; }
    .assignee { color:#333; }
    .free { color:#0a7f00; font-weight:bold; }
    .note-input { width:100%; border:1px solid #ddd; border-radius:8px; padding:8px; }

    .home-btn{
      position:fixed; left:18px; bottom:18px; border:none;
      background:#fff; color:#000; border-radius:50%;
      padding:10px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.35);
      z-index:1000; transition: box-shadow .3s ease;
    }
    .home-btn img{ width:32px; height:32px; display:block; }

    @media (max-width:720px){ .card{ grid-template-columns: 1fr; } }

    /* Debug-Pane */
    #debugPane{
      position:fixed; top:0; left:0; right:0; z-index:2000;
      font:12px/1.4 monospace; background:#111; color:#0f0;
      padding:6px 8px; border-bottom:1px solid #333; display:none; white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <!-- DEBUG PANE -->
  <div id="debugPane"></div>

  <!-- Header -->
  <div class="header" id="header">
    <img id="logo-left"   src="logos/master/logo-left.jpg"   alt="Logo links">
    <img id="logo-center" src="logos/master/logo-center.jpg" alt="Logo Mitte">
    <img id="logo-right"  src="logos/master/logo-right.jpg"  alt="Logo rechts">
  </div>

  <div class="wrap">
    <div class="toolbar">
      <h2>Snackliste</h2>
      <div class="info" id="userInfo"></div>
    </div>

    <div class="add-box">
      <label for="datePicker">Neuen Termin hinzufügen (nur Freitag oder Sonntag):</label>
      <input type="date" id="datePicker" />
      <button class="btn" id="addBtn">Termin hinzufügen</button>
      <button class="btn secondary" id="nextFriBtn">Nächster Freitag</button>
      <button class="btn secondary" id="nextSunBtn">Nächster Sonntag</button>
    </div>

    <div id="msg" class="msg"></div>

    <div class="list" id="list"></div>
  </div>

  <!-- Home -->
  <button class="home-btn" onclick="location.href='hauptseite.html'">
    <img src="home.jpg" alt="Home">
  </button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <!-- Zentrale Firebase-Config -->
  <script src="firebase-config.js"></script>

  <script>
    /* =========================
       Firebase Init (zentral)
       ========================= */
    if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

    /* =========================
       DEBUG-Helfer
       ========================= */
    const DEBUG = true; // auf false stellen, wenn nicht mehr benötigt
    function dbgShow(){ if (DEBUG) document.getElementById('debugPane').style.display='block'; }
    function dbgClear(){ const el=document.getElementById('debugPane'); if (el) el.textContent=''; }
    function dbg(line, obj){
      const el=document.getElementById('debugPane'); if (!el) return;
      const txt = `[${new Date().toLocaleTimeString()}] ${line}`;
      if (DEBUG){ el.textContent += txt + (obj ? ' ' + JSON.stringify(obj) : '') + '\n'; }
      try{ console.log(txt, obj||''); }catch(_){}
    }
    window.addEventListener('error', e=>dbg('JS ERROR',{msg:e.message,file:e.filename,line:e.lineno,col:e.colno}));
    window.addEventListener('unhandledrejection', e=>dbg('UNHANDLED REJECTION',{reason:(e.reason&&e.reason.message)||String(e.reason)}));
    dbgShow();

    /* =========================
       Header-Logik (Logos dürfen lowercase sein)
       ========================= */
    function preloadAndSet(img, url, fallback){
      if (!img) return;
      const t = new Image();
      t.onload = ()=>{ img.src = url; img.style.opacity='1'; };
      t.onerror = ()=>{ if (fallback) img.src = fallback; };
      img.style.opacity = '0.3';
      t.src = url;
    }
    function applyHeaderBySchool(school){
      const left   = document.getElementById('logo-left');
      const center = document.getElementById('logo-center');
      const right  = document.getElementById('logo-right');
      const masterBase = 'logos/master';
      const keyForLogos = String(school || 'master').toLowerCase();
      const base = keyForLogos !== 'master' ? `logos/${keyForLogos}` : masterBase;
      preloadAndSet(left,   `${base}/logo-left.jpg`,   `${masterBase}/logo-left.jpg`);
      preloadAndSet(center, `${base}/logo-center.jpg`, `${masterBase}/logo-center.jpg`);
      preloadAndSet(right,  `${base}/logo-right.jpg`,  `${masterBase}/logo-right.jpg`);
    }

    // WICHTIG: Firestore-Keys nicht verändern (case-sensitiv)
    const normSchool = s => String(s || 'Master').trim();

    /* =========================
       Helpers
       ========================= */
    const $ = (s)=>document.querySelector(s);
    const msg = (t, ok=false)=>{
      const box = $("#msg");
      box.textContent = t || " ";
      box.classList.toggle("ok", ok);
    };
    const z2 = n => String(n).padStart(2,"0");
    const toDateId = d => `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
    const fmtDate = d => d.toLocaleDateString("de-DE",{weekday:"long", year:"numeric", month:"2-digit", day:"2-digit"});
    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function nextWeekday(base, weekday){
      const d = startOfDay(base);
      const diff = (weekday - d.getDay() + 7) % 7;
      d.setDate(d.getDate() + diff);
      return d;
    }

    /* =========================
       Schulkontext & UI-Guards
       ========================= */
    // Optional: Whitelist – leere [] wenn nicht gewünscht
    const ALLOWED_SCHOOLS = ["Melsungen","Kassel","Fulda"]; // anpassen oder [] lassen

    function isValidSchoolId(v){
      if (!v) return false;
      const s = String(v).trim();
      if (!s) return false;
      if (ALLOWED_SCHOOLS.length>0) return ALLOWED_SCHOOLS.includes(s);
      return s.length >= 2;
    }
    function getQueryParam(name){
      const url = new URL(location.href);
      const val = url.searchParams.get(name);
      return val ? val.trim() : null;
    }
    function getActiveSchoolStrict(){
      const s = (sessionStorage.getItem('activeSchool') || '').trim();
      dbg('getActiveSchoolStrict ->', s);
      return s || null;
    }
    function setActiveSchool(s){
      dbg('setActiveSchool', s);
      if (!isValidSchoolId(s)) return false;
      sessionStorage.setItem('activeSchool', String(s).trim());
      return true;
    }
    function setUiBlocked(blocked, reasonText){
      dbg('setUiBlocked', {blocked, reasonText});
      const addBtn = document.getElementById('addBtn');
      addBtn.disabled = !!blocked;
      if (blocked) {
        msg(reasonText || "Bitte zuerst auf der Hauptseite eine Schule auswählen.");
        document.querySelector('.home-btn').style.boxShadow = "0 0 0 6px rgba(255,255,255,.25)";
      } else {
        msg("");
        document.querySelector('.home-btn').style.boxShadow = "";
      }
    }
    function assertSchoolSelectedOrThrow() {
      const s = getActiveSchoolStrict();
      if (!s) throw new Error("no-active-school");
      return s;
    }

    /* =========================
       Firestore-Pfade pro Schule
       ========================= */
    let CURRENT_SCHOOL = null;
    const SNACKS = () => {
      dbg('SNACKS with CURRENT_SCHOOL', CURRENT_SCHOOL);
      if (!CURRENT_SCHOOL) throw new Error("no-active-school");
      return db.collection('snacks').doc(CURRENT_SCHOOL).collection('items');
    };

    /* =========================
       Termin hinzufügen
       ========================= */
    $("#nextFriBtn").addEventListener("click", ()=>{
      const d = nextWeekday(new Date(), 5);
      $("#datePicker").value = `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
    });
    $("#nextSunBtn").addEventListener("click", ()=>{
      const d = nextWeekday(new Date(), 0);
      $("#datePicker").value = `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
    });

    $("#addBtn").addEventListener("click", async ()=>{
      try { assertSchoolSelectedOrThrow(); } catch {
        setUiBlocked(true, "Bitte zuerst auf der Hauptseite eine Schule auswählen.");
        return;
      }
      const val = $("#datePicker").value;
      if (!val) { msg("Bitte ein Datum auswählen."); return; }

      const [Y,Mo,D] = val.split("-").map(n=>parseInt(n,10));
      const d = new Date(Y, Mo-1, D);

      const today = startOfDay(new Date());
      if (d < today) { msg("Datum darf nicht in der Vergangenheit liegen."); return; }

      const wd = d.getDay(); // 0=So, 5=Fr
      if (!(wd === 0 || wd === 5)){
        msg("Nur Freitag oder Sonntag sind erlaubt."); return;
      }

      const id = toDateId(d);
      const ref = SNACKS().doc(id);

      msg("Leeren Termin anlegen …");
      try {
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(ref);
          if (snap.exists) throw new Error("exists");
          tx.set(ref, {
            dateId: id,
            date: firebase.firestore.Timestamp.fromDate(d),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        });
        msg("Termin angelegt.", true);
        $("#datePicker").value = "";
        renderList(auth.currentUser);
      } catch(e){
        msg(e.message === "exists" ? "Für dieses Datum existiert bereits ein Eintrag." : "Konnte Termin nicht anlegen.");
      }
    });

    /* =========================
       Liste rendern
       ========================= */
    async function renderList(user){
      dbg('renderList start', { user: user?.email, school: CURRENT_SCHOOL });
      if (!CURRENT_SCHOOL) return;

      const container = $("#list");
      container.innerHTML = "";

      const today = startOfDay(new Date());
      let q = SNACKS()
        .where("date", ">=", firebase.firestore.Timestamp.fromDate(today))
        .orderBy("date", "asc")
        .limit(30);

      const snap = await q.get();
      if (snap.empty){
        msg("Noch keine Termine angelegt. Lege oben einen Freitag oder Sonntag an.");
        return;
      } else {
        msg("");
      }

      snap.docs.forEach(doc=>{
        const data = doc.data();
        const date = data.date?.toDate ? data.date.toDate() : new Date(doc.id);

        const card = document.createElement("div");
        card.className = "card";

        const left = document.createElement("div");
        left.innerHTML = `<div class="date">${fmtDate(date)}</div>
                          <div class="assignee">${
                            data.assigneeName
                              ? `Eingetragen: ${data.assigneeName}`
                              : `<span class="free">Noch frei</span>`
                          }</div>`;

        const middle = document.createElement("div");
        const note = document.createElement("input");
        note.className = "note-input";
        note.placeholder = "Optionale Notiz (z. B. Obst & Nüsse)";
        note.value = data.note || "";
        note.disabled = !(data.assigneeUid === (user && user.uid));
        middle.appendChild(note);

        const right = document.createElement("div");
        const btn = document.createElement("button");
        btn.className = "btn";

        if (!data.assigneeUid){
          btn.textContent = "Ich übernehme";
          btn.onclick = ()=> claimSlot(doc.id, date, note.value);
        } else if (user && data.assigneeUid === user.uid){
          btn.textContent = "Abgeben";
          btn.classList.add("secondary");
          btn.onclick = ()=> releaseSlot(doc.id);
          note.disabled = false;
          note.addEventListener("change", ()=>{
            try { assertSchoolSelectedOrThrow(); } catch {
              setUiBlocked(true, "Bitte zuerst auf der Hauptseite eine Schule auswählen.");
              note.value = data.note || "";
              return;
            }
            SNACKS().doc(doc.id).update({
              note: note.value,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(()=> msg("Notiz gespeichert.", true))
              .catch(()=> msg("Konnte Notiz nicht speichern."));
          });
        } else {
          btn.textContent = "Belegt";
          btn.disabled = true;
        }

        right.appendChild(btn);
        card.appendChild(left);
        card.appendChild(middle);
        card.appendChild(right);
        container.appendChild(card);
      });
    }

    /* =========================
       Claim / Release
       ========================= */
    async function claimSlot(id, dateObj, noteValue){
      dbg('claimSlot', { id, school: CURRENT_SCHOOL });
      try { assertSchoolSelectedOrThrow(); } catch {
        setUiBlocked(true, "Bitte zuerst auf der Hauptseite eine Schule auswählen.");
        return;
      }
      msg("Trage dich ein …");
      const user = auth.currentUser;
      if (!user){ location.href = "index.html"; return; }

      const ref = SNACKS().doc(id);
      try {
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(ref);
          if (snap.exists && snap.data().assigneeUid) throw new Error("bereits belegt");
          tx.set(ref, {
            assigneeUid: user.uid,
            assigneeName: user.displayName || user.email || "Unbekannt",
            note: noteValue || "",
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        });
        msg("Eingetragen – danke!", true);
      } catch(e){
        msg(e.message === "bereits belegt" ? "Dieser Termin wurde gerade belegt." : "Fehler beim Eintragen.");
      } finally {
        renderList(auth.currentUser);
      }
    }

    async function releaseSlot(id){
      dbg('releaseSlot', { id, school: CURRENT_SCHOOL });
      try { assertSchoolSelectedOrThrow(); } catch {
        setUiBlocked(true, "Bitte zuerst auf der Hauptseite eine Schule auswählen.");
        return;
      }
      msg("Gib Eintrag frei …");
      const user = auth.currentUser;
      if (!user){ location.href = "index.html"; return; }

      const ref = SNACKS().doc(id);
      try {
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(ref);
          if (!snap.exists) throw new Error("nicht vorhanden");
          const data = snap.data();
          if (data.assigneeUid !== user.uid) throw new Error("nicht-berechtigt");
          tx.update(ref, {
            assigneeUid: firebase.firestore.FieldValue.delete(),
            assigneeName: firebase.firestore.FieldValue.delete(),
            note: firebase.firestore.FieldValue.delete(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        msg("Freigegeben.", true);
      } catch(e){
        let t = "Konnte nicht freigeben.";
        if (e.message === "nicht-berechtigt") t = "Nur der eingetragene Nutzer kann freigeben.";
        msg(t);
      } finally {
        renderList(auth.currentUser);
      }
    }

    /* =========================
       Auth-Flow + Fallbacks + Header
       ========================= */
    auth.onAuthStateChanged(async (user)=>{
      dbgClear();
      if (!user) { dbg('kein user → redirect'); location.href = "index.html"; return; }
      $("#userInfo").textContent = user.email || "";
      dbg('user angemeldet', {email:user.email});

      // 1) sessionStorage
      let active = getActiveSchoolStrict();
      dbg('sessionStorage.activeSchool', active);

      // 2) URL-Parameter ?school=
      if (!active) {
        const fromUrl = getQueryParam("school");
        dbg('?school param', fromUrl);
        if (fromUrl && isValidSchoolId(fromUrl)) {
          setActiveSchool(fromUrl);
          active = fromUrl;
          dbg('using ?school', fromUrl);
        }
      }

      // 3) Firestore rollen/{uid}.school
      if (!active) {
        try{
          const snap = await db.collection('rollen').doc(user.uid).get();
          dbg('rollen doc exists', snap.exists);
          if (snap.exists) {
            const schoolFromRole = (snap.data()?.school || "").trim();
            dbg('rollen.school', schoolFromRole);
            if (isValidSchoolId(schoolFromRole)) {
              setActiveSchool(schoolFromRole);
              active = schoolFromRole;
              dbg('using rollen.school', schoolFromRole);
            } else {
              dbg('rollen.school ungültig/leer');
            }
          }
        } catch(e){
          dbg('rollen fetch error', { msg: e.message });
        }
      }

      if (!active) {
        CURRENT_SCHOOL = null;
        applyHeaderBySchool('master');
        setUiBlocked(true, "Bitte zuerst auf der Hauptseite eine Schule auswählen.");
        $("#list").innerHTML = "";
        dbg('BLOCKED: keine aktive Schule gefunden');
        return;
      }

      CURRENT_SCHOOL = normSchool(active); // exakte Schreibweise beibehalten
      dbg('CURRENT_SCHOOL gesetzt', CURRENT_SCHOOL);
      setUiBlocked(false, "");
      applyHeaderBySchool(CURRENT_SCHOOL);
      renderList(user);
    });
  </script>
</body>
</html>
