<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trainingszeiten</title>
  <style>
    :root{ --bg:#000; --text:#fff; --muted:#aaa; --field:#111; --border:#2a2a2a; --ok:#2ecc71; --red:#f44;}
    *{ box-sizing:border-box; }
    body{ margin:0; background:#000; color:#fff; font-family:Arial, Helvetica, sans-serif; -webkit-font-smoothing:antialiased; min-height:100vh; display:flex; flex-direction:column; }
    .wrap{ width:100%; max-width:1100px; margin:0 auto; padding:20px 16px 80px; }

    .top-bar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .user-info{ background:#111; border:1px solid #333; border-radius:10px; padding:8px 14px; font-size:14px; color:#ddd; }
    .user-info span{ color:#2ecc71; font-weight:bold; }
    .controls{ display:flex; gap:8px; align-items:center; }
    .btn{ background:#fff; color:#000; border:none; border-radius:10px; padding:8px 12px; font-weight:bold; cursor:pointer; }
    .btn.ghost{ background:transparent; color:#fff; border:1px solid var(--border); }
    .btn.danger{ background:var(--red); color:#fff; }
    select.school{ background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:6px 10px; }

    h1{ margin:0 0 8px; font-size:24px; }
    .hint{ color:var(--muted); margin-bottom:18px; font-size:14px; }

    .day{ margin-top:18px; border-top:1px solid var(--border); padding-top:14px; }
    .day h2{ margin:0 0 8px; font-size:18px; color:#eaeaea; letter-spacing:.2px; display:flex; gap:8px; align-items:center; }
    .day h2 input{ background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:6px 8px; }

    .slot{ display:grid; grid-template-columns: 420px 1fr 120px; gap:10px; align-items:center; padding:10px 0; border-bottom:1px dashed #1c1c1c; }
    .info{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .label{ font-size:15px; color:#eaeaea; line-height:1.3; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .label .daychip{ font-weight:bold; }
    .label .sep{ opacity:.6; padding:0 6px; }
    .label .time{ font-weight:bold; letter-spacing:.2px; }
    .editline input{ background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:6px 8px; }
    .editline{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .field{ display:grid; grid-template-columns:repeat(6, minmax(120px,1fr)); gap:8px; }
    input.name{ background:var(--field); color:#fff; border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-size:15px; outline:none; width:100%; }
    input.name:disabled{ opacity:.7; color:#bbb; }

    .status{ font-size:12px; color:var(--muted); opacity:.85; }
    .status.ok{ color:var(--ok); }

    @media (max-width:1100px){
      .slot{ grid-template-columns:1fr; align-items:start; }
      .field{ grid-template-columns:repeat(3, 1fr); }
      .status{ grid-column:1 / -1; }
    }
    @media (max-width:600px){
      .field{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-bar">
      <h1>Trainingszeiten</h1>
      <div class="controls">
        <select id="schoolSelect" class="school" title="Schule w√§hlen"></select>
        <button id="editSchemaBtn" class="btn ghost" style="display:none">‚úèÔ∏è Struktur bearbeiten</button>
        <button id="addDayBtn" class="btn ghost" style="display:none">‚ûï Tag</button>
        <button id="saveSchemaBtn" class="btn" style="display:none">üíæ Struktur speichern</button>
        <button id="cancelSchemaBtn" class="btn danger" style="display:none">Abbrechen</button>
      </div>
      <div id="userInfo" class="user-info">
        Rolle: <span id="userRole">‚Ä¶</span> |
        Gruppe: <span id="userSchool">‚Ä¶</span>
      </div>
    </div>

    <div class="hint" id="hint">
      Bitte oben zuerst eine Schule w√§hlen. Nur <b>Admin</b> &amp; <b>Si-Fu</b> k√∂nnen Namen und Struktur √§ndern.
    </div>

    <div id="schedule"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
  if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();
  auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const slug = s => String(s||'').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  const normalizeRole = r => {
    r=(r||"").toLowerCase();
    if(['administrator','admins','adminstrator'].includes(r)) r='admin';
    if(['trainer/in','trainerin','coach'].includes(r)) r='trainer';
    if(['si-fu','sifu','si fu','si‚Äêfu','si‚Äífu'].includes(r)) r='si-fu';
    return r;
  };
  function splitSchoolsString(str){ if(!str) return []; return String(str).split(/[,\n;]+/).map(s=>s.trim()).filter(Boolean); }
  async function getDocFlexible(col,key){
    const base=(key??'').trim();
    const tries=[base,base.toUpperCase(),base.charAt(0).toUpperCase()+base.slice(1).toLowerCase(),base.toLowerCase()];
    for(const id of tries){ try{ const snap=await db.collection(col).doc(id).get(); if(snap.exists) return {snap,id}; }catch(e){} }
    return null;
  }
  async function loadAccessibleSchools(groupKey){
    const r = await getDocFlexible('Schulen', groupKey);
    if(!r) return [];
    const d = r.snap.data()||{};
    if(Array.isArray(d.School)) return d.School.map(String).map(s=>s.trim()).filter(Boolean);
    if(typeof d.School==='string') return splitSchoolsString(d.School);
    if(Array.isArray(d.schools)) return d.schools.map(String).map(s=>s.trim()).filter(Boolean);
    if(typeof d.schools==='string') return splitSchoolsString(d.schools);
    return [];
  }

  // ---------- State ----------
  let STATE = {
    role: 'user',
    school: '',
    groupKey: '',
    canEdit: false,
    editMode: false,
    schema: null,
    belegung: {},
  };

  const COL = (school) => db.collection('trainingszeiten').doc(school).collection('trainingszeiten');
  const REF_SCHEMA = (school) => COL(school).doc('schema');
  const REF_BELEG  = (school) => COL(school).doc('belegung');

  const DEFAULT_SCHEMA = {
    slots: [
      { day: "Montag", slots: [
        { time: "17:30-18:15", what: "Jugendliche 8-12 Jahre", cap: 6 },
        { time: "19:30-21:00", what: "Erwachsene ab 13 Jahre", cap: 6 },
      ]},
      { day: "Mittwoch", slots: [
        { time: "16:30-17:15", what: "Minis ab 4 Jahre", cap: 6 },
        { time: "17:30-18:15", what: "Kids 5-7 Jahre", cap: 6 },
        { time: "18:30-19:15", what: "Jugendliche 8-12 Jahre", cap: 6 },
        { time: "19:30-21:00", what: "Erwachsene ab 13 Jahre", cap: 6 },
      ]},
    ]
  };

  function padN(arr, n){ const out = Array.isArray(arr) ? arr.slice(0, n) : []; while(out.length<n) out.push(""); return out; }

  async function ensureSchemaExists(school){
    const ref = REF_SCHEMA(school);
    const snap = await ref.get();
    if (snap.exists) return true;
    try{ await ref.set(DEFAULT_SCHEMA); return true; }catch(e){ console.error(e); return false; }
  }

  async function loadAllForSchool(school){
    await ensureSchemaExists(school);
    const [schemaSnap, belegSnap] = await Promise.all([
      REF_SCHEMA(school).get(),
      REF_BELEG(school).get().catch(e=>({exists:false, data:()=>({})})),
    ]);
    const schema = (schemaSnap.exists ? schemaSnap.data() : {slots:[]});
    const beleg  = (belegSnap.exists ? belegSnap.data() : {});
    return { schema, beleg };
  }

  const root = $('schedule');

  // ---------- Render View ----------
  function renderView(){
    root.innerHTML = "";
    const { schema, canEdit, editMode } = STATE;
    const beleg = STATE.belegung || {};

    $('hint').innerHTML = !STATE.school
      ? 'Bitte oben zuerst eine Schule w√§hlen.'
      : editMode
        ? 'Struktur bearbeiten.'
        : 'Nur <b>Admin</b> &amp; <b>Si-Fu</b> k√∂nnen Namen und Struktur √§ndern.';

    if (!STATE.school) return;

    for (const group of (schema.slots || [])) {
      const day = document.createElement('div');
      day.className = 'day';

      const h2 = document.createElement('h2');
      if (editMode && canEdit){
        const dayInput = document.createElement('input');
        dayInput.value = group.day || '';
        dayInput.oninput = ()=>{ group.day = dayInput.value; renderView(); };
        h2.appendChild(dayInput);

        const addSlotBtn = document.createElement('button');
        addSlotBtn.className='btn ghost';
        addSlotBtn.textContent='‚ûï Slot';
        addSlotBtn.onclick = ()=>{ group.slots.push({ time:'', what:'', cap:6 }); renderView(); };
        h2.appendChild(addSlotBtn);
      } else {
        h2.textContent = group.day || '‚Äî';
      }
      day.appendChild(h2);

      for (const slot of (group.slots || [])) {
        const id = `${slug(group.day)}__${slug(slot.time)}`;
        const cap = Math.max(1, Number(slot.cap||6));
        const row = document.createElement('div');
        row.className = 'slot';

        const info = document.createElement('div');
        info.className = 'info';
        const label = document.createElement('div');
        label.className='label';
        label.innerHTML=`<span class="daychip">${group.day}</span><span class="sep">‚Äì</span><span>${slot.what}</span><span class="sep">‚Äì</span><span>${slot.time}</span>`;
        info.appendChild(label);

        const field=document.createElement('div');
        field.className='field';
        field.style.gridTemplateColumns = `repeat(${cap}, minmax(120px,1fr))`;
        const current = padN(beleg[id], cap);

        for (let i=0;i<cap;i++){
          const input=document.createElement('input');
          input.type='text';
          input.placeholder=`Name ${i+1}`;
          input.className='name';
          input.dataset.slotId=id;
          input.dataset.index=String(i);
          input.disabled = !(canEdit && !editMode);
          input.value = current[i]||'';
          if (!input.disabled){
            input.addEventListener('input',()=>scheduleSave(id));
          }
          field.appendChild(input);
        }

        const status=document.createElement('div');
        status.className='status';
        status.id=`st_${id}`;
        status.textContent=' ';
        row.appendChild(info); row.appendChild(field); row.appendChild(status);
        day.appendChild(row);
      }
      root.appendChild(day);
    }
  }

  // ---------- Save ----------
  let saveTimer=null;
  function scheduleSave(slotId){
    clearTimeout(saveTimer);
    const st=$(`st_${slotId}`);
    if(st){st.textContent='speichern‚Ä¶';st.classList.remove('ok');}
    saveTimer=setTimeout(doSave,400);
  }
  async function doSave(){
    const data={};
    document.querySelectorAll('input.name').forEach(inp=>{
      const sid=inp.dataset.slotId;
      const idx=+inp.dataset.index;
      data[sid]=data[sid]||[];
      data[sid][idx]=(inp.value||'').trim();
    });
    try{
      await REF_BELEG(STATE.school).set(data,{merge:false});
      STATE.belegung=data;
      Object.keys(data).forEach(sid=>{
        const st=$(`st_${sid}`);
        if(st){st.textContent='gespeichert';st.classList.add('ok');}
      });
    }catch(e){
      console.error(e);
      Object.keys(data).forEach(sid=>{
        const st=$(`st_${sid}`); if(st){st.textContent='Fehler';}
      });
    }
  }

  // ---------- Schul-Dropdown ----------
  async function setupSchoolPicker(){
    const sel=$('schoolSelect'); sel.disabled=true;
    const groupKey=(sessionStorage.getItem('school')||'').trim()||'MASTER';
    STATE.groupKey=groupKey;
    let list=await loadAccessibleSchools(groupKey);
    list=list.map(s=>s.toLowerCase());
    sel.innerHTML='<option value="">‚Äî bitte Schule w√§hlen ‚Äî</option>';
    list.forEach(name=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o); });
    sel.disabled=false;
    sel.onchange=async()=>{
      const v=(sel.value||'').toLowerCase();
      sessionStorage.setItem('activeSchool',v);
      STATE.school=v;
      const {schema,beleg}=await loadAllForSchool(v);
      STATE.schema=schema; STATE.belegung=beleg||{}; renderView();
    };
  }

  auth.onAuthStateChanged(async user=>{
    if(!user){location.href='index.html';return;}
    const rdoc=await db.collection('rollen').doc(user.uid).get();
    let role='user', school='MASTER';
    if(rdoc.exists){const d=rdoc.data();role=normalizeRole(d.role);school=d.school||'MASTER';}
    STATE.role=role; STATE.canEdit=(role==='admin'||role==='si-fu');
    $('userRole').textContent=role; $('userSchool').textContent=school;
    await setupSchoolPicker();
  });
  </script>
</body>
</html>
