<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trainingszeiten</title>
  <style>
    body {
      margin:0; background:#000; color:#fff; font-family:Arial,Helvetica,sans-serif;
      display:flex; flex-direction:column; align-items:center;
    }
    /* HEADER (identisch wie andere Seiten) */
    .header{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 16px; gap:12px; border-bottom:1px solid #222; width:100%;
    }
    .header img{ height:80px; width:auto; object-fit:contain; }
    @media (max-width:750px){ .header img{ height:44px; } }
    @media (max-width:480px){ .header img{ height:40px; } }

    .top-bar{
      display:flex;justify-content:space-between;align-items:center;
      width:100%;max-width:900px;flex-wrap:wrap;gap:10px;
      padding:20px;
    }
    .btn{
      background:#fff;color:#000;border:none;border-radius:8px;
      padding:8px 12px;font-weight:bold;cursor:pointer;
    }
    .btn.ghost{background:transparent;color:#fff;border:1px solid #333;}
    select, input[type="text"], input[type="time"]{
      background:#111;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px;
    }
    select[disabled]{opacity:.75; cursor:not-allowed;}
    .wrap{max-width:900px;width:100%;margin-top:10px;padding:0 20px 40px;}
    .card{
      background:#111;border:1px solid #333;border-radius:10px;
      padding:12px 16px;margin-bottom:10px;
    }
    .trainers{display:flex;flex-direction:column;gap:4px;margin-top:8px;}
    .hint{color:#aaa;font-size:14px;margin-top:12px;}
    .day-label{font-weight:bold;color:#2ecc71;}

    /* Home-Button (optional, wie die anderen Seiten) */
    .home-btn{
      position:fixed; left:18px; bottom:18px;
      border:none; background:#fff; color:#000;
      border-radius:50%; padding:10px; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.35); z-index:1000;
    }
    .home-btn img{ width:32px; height:32px; display:block; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header" id="header">
    <img id="logo-left" src="pluslogo.png" alt="Logo links">
    <img id="logo-center" src="faust.jpg" alt="Logo Mitte">
    <img id="logo-right" src="melsungen.jpg" alt="Logo rechts">
  </div>

  <div class="top-bar">
    <h1>Trainingszeiten</h1>
    <!-- Dropdown zeigt nur die aktive Schule und ist deaktiviert -->
    <select id="schoolSelect" disabled></select>
    <button id="addTrainingBtn" class="btn" style="display:none;">‚ûï Training hinzuf√ºgen</button>
  </div>
  <div id="schedule" class="wrap"></div>

  <!-- Home-Button (falls gew√ºnscht) -->
  <button class="home-btn" onclick="location.href='hauptseite.html'">
    <img src="home.jpg" alt="Home">
  </button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
  if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();

  const DAYS=["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];
  const $=id=>document.getElementById(id);

  let STATE={
    school:'',
    role:'user',
    canEdit:false,
    trainings:[]
  };

  const COL = school => db.collection('trainingszeiten').doc(school).collection('trainingszeiten');

  // ---------- Lade Trainings ----------
  async function loadTrainings(school){
    const col=await COL(school).get();
    STATE.trainings=col.docs.map(d=>({id:d.id,...d.data()}));
    renderTrainings();
  }

  // ---------- Render ----------
  function renderTrainings(){
    const wrap=$('schedule');
    wrap.innerHTML="";
    if(!STATE.school){
      wrap.innerHTML="<div class='hint'>Bitte zuerst auf der Hauptseite eine Schule w√§hlen.</div>";
      return;
    }
    if(STATE.trainings.length===0){
      wrap.innerHTML="<div class='hint'>Keine Trainingszeiten eingetragen.</div>";
      return;
    }
    STATE.trainings.sort((a,b)=>DAYS.indexOf(a.day)-DAYS.indexOf(b.day));
    for(const t of STATE.trainings){
      const card=document.createElement('div');
      card.className='card';
      card.innerHTML=`
        <div><span class="day-label">${t.day}</span> ‚Äì <b>${t.what||''}</b></div>
        <div>${t.start||''}‚Äì${t.end||''}</div>
        <div>Trainer: ${(t.trainers||[]).join(', ')||'-'}</div>
      `;
      wrap.appendChild(card);
    }
  }

  // ---------- Neues Training hinzuf√ºgen ----------
  function addTrainingForm(){
    const wrap=$('schedule');
    const card=document.createElement('div');
    card.className='card';

    const daySel=document.createElement('select');
    daySel.innerHTML='<option value="">Wochentag w√§hlen</option>'+DAYS.map(d=>`<option value="${d}">${d}</option>`).join('');

    const what=document.createElement('input');
    what.type='text'; what.placeholder='z.B. Kids 4‚Äì10 Jahre'; what.style.display='none';

    const timeWrap=document.createElement('div'); timeWrap.style.display='none';
    const start=document.createElement('input'); start.type='time';
    const end=document.createElement('input'); end.type='time';
    timeWrap.append('Beginn:',start,' Ende:',end);

    const trainersWrap=document.createElement('div'); trainersWrap.className='trainers'; trainersWrap.style.display='none';
    const addTrainerBtn=document.createElement('button'); addTrainerBtn.className='btn ghost'; addTrainerBtn.textContent='‚ûï Trainer hinzuf√ºgen';
    const trainers=[];

    addTrainerBtn.onclick=()=>{
      const inp=document.createElement('input');
      inp.type='text'; inp.placeholder='Trainername';
      trainersWrap.insertBefore(inp,addTrainerBtn);
      trainers.push(inp);
    };

    trainersWrap.append(addTrainerBtn);

    const saveBtn=document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='üíæ Speichern'; saveBtn.style.display='none';

    card.append('Wochentag: ',daySel, document.createElement('br'), what, timeWrap, trainersWrap, document.createElement('br'), saveBtn);
    wrap.prepend(card);

    daySel.onchange=()=>{ if(daySel.value){ what.style.display='block'; } };
    what.oninput=()=>{ if(what.value.trim()){ timeWrap.style.display='block'; } };
    end.onchange=()=>{ trainersWrap.style.display='block'; saveBtn.style.display='block'; };

    saveBtn.onclick=async()=>{
      const entry={
        day: daySel.value,
        what: what.value.trim(),
        start: start.value,
        end: end.value,
        trainers: trainers.map(i=>i.value.trim()).filter(Boolean)
      };
      if(!entry.day||!entry.what||!entry.start||!entry.end){
        alert("Bitte alle Felder ausf√ºllen.");
        return;
      }
      try{
        await COL(STATE.school).add(entry);
        alert("Training gespeichert!");
        await loadTrainings(STATE.school);
      }catch(e){
        console.error(e);
        alert("Fehler beim Speichern.");
      }
    };
  }

  // ---------- Logos ----------
  function preloadAndSet(imgEl, url){
    const test = new Image();
    test.onload = ()=>{ imgEl.src = url; };
    test.onerror = ()=>{};
    test.src = url;
  }
  function applyLogosForSchool(sch){
    if(!sch || sch.toLowerCase()==='master') return;
    const base = `logos/${sch.toLowerCase()}`;
    preloadAndSet(document.getElementById('logo-left'), `${base}/logo-left.jpg`);
    preloadAndSet(document.getElementById('logo-center'), `${base}/logo-center.jpg`);
    preloadAndSet(document.getElementById('logo-right'), `${base}/logo-right.jpg`);
  }

  // ---------- Init: feste Schule aus der Hauptseite ----------
  async function initFixedSchoolFlow(user){
    // aktive Schule MUSS von der Hauptseite kommen
    let active = (sessionStorage.getItem('activeSchool') || '').trim().toLowerCase();

    // Fallback: ggf. alte Session-"school" verwenden
    if(!active){
      const fallback = (sessionStorage.getItem('school') || '').trim().toLowerCase();
      if (fallback && fallback !== 'master') active = fallback;
    }

    // Kein aktiver Eintrag oder MASTER ‚Üí Hinweis & optional Redirect
    if(!active || active === 'master'){
      $('schoolSelect').innerHTML = '<option value="">(keine Schule gew√§hlt)</option>';
      $('schoolSelect').disabled = true;
      $('schedule').innerHTML = "<div class='hint'>Bitte zuerst auf der Hauptseite eine Schule ausw√§hlen.</div>";
      // location.href = 'hauptseite.html'; // falls du direkt zur√ºck leiten willst, Zeile aktivieren
      return;
    }

    // Dropdown nur als Anzeige der fixen Schule
    const sel = $('schoolSelect');
    sel.innerHTML = '';
    const opt = document.createElement('option');
    opt.value = active;
    opt.textContent = active.toUpperCase(); // Anzeige ‚Äì passe bei Bedarf an
    sel.appendChild(opt);
    sel.value = active;
    sel.disabled = true;

    STATE.school = active;

    // Logos + Daten
    applyLogosForSchool(active);
    await loadTrainings(active);

    // Edit-Button freigeben, wenn Rolle darf
    if (STATE.canEdit) $('addTrainingBtn').style.display = 'inline-block';
  }

  // ---------- Auth ----------
  auth.onAuthStateChanged(async user=>{
    if(!user){location.href='index.html';return;}
    // Rolle lesen (nur f√ºr canEdit ‚Äì Auswahl/Wechsel kommt NICHT mehr von hier)
    try{
      const r=await db.collection('rollen').doc(user.uid).get();
      let role='user';
      if(r.exists){
        const d=r.data();
        role = (d.role || 'user').toString().toLowerCase();
      }
      STATE.role = role;
      STATE.canEdit = (role==='admin' || role==='si-fu' || role==='master');
    }catch(e){
      console.warn('Rolle konnte nicht geladen werden', e);
      STATE.role = 'user'; STATE.canEdit = false;
    }

    // Starte festen Schul-Flow (nur aktive Schule aus Hauptseite)
    await initFixedSchoolFlow(user);
  });

  $('addTrainingBtn').onclick=addTrainingForm;
  </script>
</body>
</html>
