<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trainingszeiten</title>
  <style>
    :root{ --bg:#000; --text:#fff; --muted:#aaa; --field:#111; --border:#2a2a2a; --ok:#2ecc71; --red:#f44;}
    *{ box-sizing:border-box; }
    body{ margin:0; background:#000; color:#fff; font-family:Arial, Helvetica, sans-serif; -webkit-font-smoothing:antialiased; min-height:100vh; display:flex; flex-direction:column; }
    .wrap{ width:100%; max-width:1100px; margin:0 auto; padding:20px 16px 80px; }

    .top-bar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap; }
    .user-info{ background:#111; border:1px solid #333; border-radius:10px; padding:8px 14px; font-size:14px; color:#ddd; }
    .user-info span{ color:#2ecc71; font-weight:bold; }
    .controls{ display:flex; gap:8px; align-items:center; }
    .btn{ background:#fff; color:#000; border:none; border-radius:10px; padding:8px 12px; font-weight:bold; cursor:pointer; }
    .btn.ghost{ background:transparent; color:#fff; border:1px solid var(--border); }
    .btn.danger{ background:var(--red); color:#fff; }

    h1{ margin:0 0 8px; font-size:24px; }
    .hint{ color:var(--muted); margin-bottom:18px; font-size:14px; }
    select.school{ background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:6px 10px; }

    .day{ margin-top:18px; border-top:1px solid var(--border); padding-top:14px; }
    .day h2{ margin:0 0 8px; font-size:18px; color:#eaeaea; letter-spacing:.2px; display:flex; gap:8px; align-items:center; }
    .day h2 input{ background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:6px 8px; }

    .slot{ display:grid; grid-template-columns: 420px 1fr 120px; gap:10px; align-items:center; padding:10px 0; border-bottom:1px dashed #1c1c1c; }
    .info{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .label{ font-size:15px; color:#eaeaea; line-height:1.3; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .label .daychip{ font-weight:bold; }
    .label .sep{ opacity:.6; padding:0 6px; }
    .label .time{ font-weight:bold; letter-spacing:.2px; }
    .editline input{ background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:6px 8px; }
    .editline{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .field{ display:grid; grid-template-columns:repeat(6, minmax(120px,1fr)); gap:8px; }
    input.name{ background:var(--field); color:#fff; border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-size:15px; outline:none; width:100%; }
    input.name:disabled{ opacity:.7; color:#bbb; }

    .status{ font-size:12px; color:var(--muted); opacity:.85; }
    .status.ok{ color:var(--ok); }

    @media (max-width:1100px){
      .slot{ grid-template-columns:1fr; align-items:start; }
      .field{ grid-template-columns:repeat(3, 1fr); }
      .status{ grid-column:1 / -1; }
    }
    @media (max-width:600px){
      .field{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-bar">
      <h1>Trainingszeiten</h1>
      <div class="controls">
        <!-- ‚òÖ Nur sichtbar, wenn aktive Schule MASTER ist -->
        <select id="schoolSelect" class="school" style="display:none"></select>
        <button id="editSchemaBtn" class="btn ghost" style="display:none">‚úèÔ∏è Struktur bearbeiten</button>
        <button id="addDayBtn" class="btn ghost" style="display:none">‚ûï Tag</button>
        <button id="saveSchemaBtn" class="btn" style="display:none">üíæ Struktur speichern</button>
        <button id="cancelSchemaBtn" class="btn danger" style="display:none">Abbrechen</button>
      </div>
      <div id="userInfo" class="user-info">
        Rolle: <span id="userRole">‚Ä¶</span> |
        Schule: <span id="userSchool">‚Ä¶</span>
      </div>
    </div>

    <div class="hint" id="hint">
      Nur <b>Admin</b> &amp; <b>Si-Fu</b> k√∂nnen Namen und Struktur √§ndern.
      Trainer sehen die Eintr√§ge, k√∂nnen sie aber nicht √§ndern.
    </div>

    <div id="schedule"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
  // ---------- Firebase Init ----------
  if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();
  auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

  // ---------- Helpers ----------
  const slug = s => String(s||'').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  const root = document.getElementById('schedule');
  const $ = id => document.getElementById(id);

  // ---------- State ----------
  let STATE = {
    role: 'user',
    school: '',          // effektive Schule (aktiv)
    isMasterScope: false,
    canEdit: false,      // Admin/Si-Fu
    editMode: false,     // Schema-Bearbeitung aktiv
    schema: null,        // { slots:[{day,slots:[{time, what, cap}]}] }
    belegung: {},        // { slotId: [names] }
  };

  // ---------- Firestore Refs (neu) ----------
  // ‚òÖ trainingszeiten/{school}/trainingszeiten/{docId}
  const COL = (school) => db.collection('trainingszeiten').doc(school).collection('trainingszeiten');
  const REF_SCHEMA = (school) => COL(school).doc('schema');
  const REF_BELEG  = (school) => COL(school).doc('belegung');

  // ---------- Default-Schema (nur beim allerersten Mal) ----------
  const DEFAULT_SCHEMA = {
    slots: [
      { day: "Montag", slots: [
        { time: "17:30-18:15", what: "Jugendliche 8-12 Jahre", cap: 6 },
        { time: "19:30-21:00", what: "Erwachsene ab 13 Jahre", cap: 6 },
      ]},
      { day: "Mittwoch", slots: [
        { time: "16:30-17:15", what: "Minis ab 4 Jahre", cap: 6 },
        { time: "17:30-18:15", what: "Kids 5-7 Jahre", cap: 6 },
        { time: "18:30-19:15", what: "Jugendliche 8-12 Jahre", cap: 6 },
        { time: "19:30-21:00", what: "Erwachsene ab 13 Jahre", cap: 6 },
      ]},
      { day: "Donnerstag", slots: [
        { time: "16:30-17:15", what: "Minis ab 4 Jahre", cap: 6 },
        { time: "17:30-18:15", what: "Kids 5-7 Jahre", cap: 6 },
        { time: "18:45-19:45", what: "ChiKung", cap: 6 },
      ]},
    ]
  };

  // ---------- Laden & Rendern ----------
  function padN(arr, n){
    const out = Array.isArray(arr) ? arr.slice(0, n) : [];
    while(out.length<n) out.push("");
    return out;
  }

  function getActiveSchool(){
    // bevorzugt die vom Hauptmen√º gesetzte activeSchool
    const a = (sessionStorage.getItem('activeSchool')||'').trim();
    const s = (sessionStorage.getItem('school')||'').trim();
    const eff = a || s || 'MASTER';
    return eff.toLowerCase();
  }

  function normalizeRole(r){
    r=(r||"").toLowerCase();
    if(['administrator','admins','adminstrator'].includes(r)) r='admin';
    if(['trainer/in','trainerin','coach'].includes(r)) r='trainer';
    if(['si-fu','sifu','si fu','si‚Äêfu','si‚Äífu'].includes(r)) r='si-fu';
    return r;
  }

  async function ensureSchemaExists(school){
    const snap = await REF_SCHEMA(school).get();
    if (!snap.exists) {
      await REF_SCHEMA(school).set(DEFAULT_SCHEMA);
    }
  }

  async function loadAllForSchool(school){
    await ensureSchemaExists(school);
    const [schemaSnap, belegSnap] = await Promise.all([
      REF_SCHEMA(school).get(),
      REF_BELEG(school).get(),
    ]);
    const schema = schemaSnap.data() || { slots: [] };
    const beleg  = belegSnap.exists ? (belegSnap.data()||{}) : {};
    return { schema, beleg };
  }

  function renderView(){
    root.innerHTML = "";

    const { schema, beleg, canEdit, editMode, school } = STATE;

    // Hinweis oben aktualisieren
    $('hint').innerHTML = editMode
      ? 'Struktur bearbeiten: Tage, Zeiten, Bezeichnung und Kapazit√§t. √Ñnderungen erst nach <b>‚ÄûStruktur speichern‚Äú</b> wirksam.'
      : 'Nur <b>Admin</b> &amp; <b>Si-Fu</b> k√∂nnen Namen und Struktur √§ndern. Trainer sehen die Eintr√§ge, k√∂nnen sie aber nicht √§ndern.';

    for(const group of (schema.slots || [])){
      const day = document.createElement('div');
      day.className = 'day';

      // √úberschrift Tag
      const h2 = document.createElement('h2');
      if (editMode && canEdit){
        const dayInput = document.createElement('input');
        dayInput.value = group.day || '';
        dayInput.placeholder = 'Tag';
        dayInput.oninput = ()=>{ group.day = dayInput.value; renderView(); };
        h2.appendChild(dayInput);

        const addSlotBtn = document.createElement('button');
        addSlotBtn.className='btn ghost';
        addSlotBtn.textContent='‚ûï Slot';
        addSlotBtn.onclick = ()=>{
          group.slots = group.slots || [];
          group.slots.push({ time:'', what:'', cap:6 });
          renderView();
        };
        h2.appendChild(addSlotBtn);

        const delDayBtn = document.createElement('button');
        delDayBtn.className='btn danger';
        delDayBtn.textContent='üóëÔ∏è Tag';
        delDayBtn.onclick=()=>{
          STATE.schema.slots = STATE.schema.slots.filter(d=>d!==group);
          renderView();
        };
        h2.appendChild(delDayBtn);
      } else {
        h2.textContent = group.day || '‚Äî';
      }
      day.appendChild(h2);

      for(const slot of (group.slots||[])){
        const id = `${slug(group.day)}__${slug(slot.time)}`;
        const cap = Math.max(1, Number(slot.cap||6));
        const row = document.createElement('div');
        row.className = 'slot';

        // Info / Editline
        const info = document.createElement('div');
        info.className = 'info';
        if (editMode && canEdit){
          const line = document.createElement('div');
          line.className='editline';
          const inWhat = document.createElement('input'); inWhat.placeholder='Bezeichnung'; inWhat.value = slot.what||'';
          const inTime = document.createElement('input'); inTime.placeholder='Zeit (z.B. 17:30-18:15)'; inTime.value = slot.time||'';
          const inCap  = document.createElement('input'); inCap.type='number'; inCap.min='1'; inCap.max='20'; inCap.value=cap; inCap.style.width='90px'; inCap.title='Kapazit√§t';
          inWhat.oninput=()=>{ slot.what=inWhat.value; renderView(); };
          inTime.oninput=()=>{ slot.time=inTime.value; renderView(); };
          inCap.oninput =()=>{ slot.cap = Math.max(1, Number(inCap.value||6)); renderView(); };

          const delBtn=document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='üóëÔ∏è Slot';
          delBtn.onclick=()=>{
            group.slots = group.slots.filter(s=>s!==slot);
            renderView();
          };

          line.append('Bezeichnung:', inWhat, 'Zeit:', inTime, 'Pl√§tze:', inCap, delBtn);
          info.appendChild(line);
        } else {
          const label=document.createElement('div');
          label.className='label';
          label.innerHTML = `<span class="daychip">${group.day||''}</span>
                             <span class="sep">‚Äì</span>
                             <span class="what">${slot.what || ""}</span>
                             <span class="sep">‚Äì</span>
                             <span class="time">${slot.time||''}</span>`;
          info.appendChild(label);
        }

        // Eingabefelder (Cap dynamisch)
        const field=document.createElement('div');
        field.className='field';
        field.style.gridTemplateColumns = `repeat(${cap}, minmax(120px,1fr))`;

        const current = padN(beleg[id], cap);
        for(let i=0;i<cap;i++){
          const input=document.createElement('input');
          input.type='text';
          input.placeholder=`Name ${i+1}`;
          input.className='name';
          input.dataset.slotId=id;
          input.dataset.index=String(i);
          input.disabled = !(canEdit && !editMode); // w√§hrend Schema-Edit: Namen nicht √§nderbar
          input.value = current[i]||'';
          if (!input.disabled){
            input.addEventListener('input',()=>scheduleSave(id));
          }
          field.appendChild(input);
        }

        // Status
        const status=document.createElement('div');
        status.className='status';
        status.id=`st_${id}`;
        status.textContent=' ';

        row.appendChild(info);
        row.appendChild(field);
        row.appendChild(status);
        day.appendChild(row);
      }

      root.appendChild(day);
    }
  }

  let saveTimer=null;
  function scheduleSave(slotId){
    clearTimeout(saveTimer);
    const st=$(`st_${slotId}`);
    if(st){st.textContent='speichern‚Ä¶';st.classList.remove('ok');}
    saveTimer=setTimeout(doSave,400);
  }

  async function doSave(){
    // Namen aus UI zusammensammeln anhand aktueller Kapazit√§t
    const data={};
    document.querySelectorAll('input.name').forEach(inp=>{
      const sid=inp.dataset.slotId;
      const idx=+inp.dataset.index;
      data[sid]=data[sid]||[];
      data[sid][idx]= (inp.value||'').trim();
    });

    try{
      await REF_BELEG(STATE.school).set(data,{merge:false});
      STATE.belegung = data;
      Object.keys(data).forEach(sid=>{
        const st=$(`st_${sid}`);
        if(st){st.textContent='gespeichert';st.classList.add('ok');}
      });
    }catch(e){
      console.error("Speichern fehlgeschlagen:",e);
      const msg=(e&&e.code)?e.code:(e&&e.message)?e.message:'Fehler';
      Object.keys(data).forEach(sid=>{
        const st=$(`st_${sid}`);
        if(st){st.textContent='Fehler: '+msg;st.classList.remove('ok');}
      });
    }
  }

  // ---------- Schema speichern ----------
  async function saveSchema(){
    try{
      // Aufr√§umen: leere Slots/Tage entfernen
      const cleaned = { slots: (STATE.schema.slots||[])
        .map(d=>({ day:(d.day||'').trim(),
                   slots:(d.slots||[]).map(s=>({
                     time:(s.time||'').trim(),
                     what:(s.what||'').trim(),
                     cap: Math.max(1, Number(s.cap||6))
                   })).filter(s=>s.time||s.what) }))
        .filter(d=>d.day && d.slots.length>0)
      };
      await REF_SCHEMA(STATE.school).set(cleaned,{merge:false});
      STATE.schema = cleaned;
      STATE.editMode=false;
      // Nach Struktur√§nderung alte Belegung auf g√ºltige Slots trimmen
      const newIds = new Set();
      for(const d of cleaned.slots){
        for(const s of d.slots){
          newIds.add(`${slug(d.day)}__${slug(s.time)}`);
        }
      }
      const trimmed = {};
      for(const id of newIds){
        // vorhandene Namen soweit m√∂glich √ºbernehmen und auf neue cap trimmen
        const found = STATE.belegung[id] || [];
        // cap lookup:
        let cap=6;
        for(const d of cleaned.slots){
          for(const s of d.slots){
            if(`${slug(d.day)}__${slug(s.time)}`===id){ cap = Math.max(1, Number(s.cap||6)); }
          }
        }
        trimmed[id] = padN(found, cap);
      }
      await REF_BELEG(STATE.school).set(trimmed,{merge:false});
      STATE.belegung = trimmed;

      renderView();
      toggleSchemaButtons();
    }catch(e){
      alert('Fehler beim Speichern der Struktur: '+(e?.message||e));
    }
  }

  function toggleSchemaButtons(){
    const showEditUI = STATE.canEdit;
    $('editSchemaBtn').style.display = showEditUI && !STATE.editMode ? 'inline-block' : 'none';
    $('addDayBtn').style.display     = showEditUI &&  STATE.editMode ? 'inline-block' : 'none';
    $('saveSchemaBtn').style.display = showEditUI &&  STATE.editMode ? 'inline-block' : 'none';
    $('cancelSchemaBtn').style.display=showEditUI &&  STATE.editMode ? 'inline-block' : 'none';
  }

  function enterEdit(){
    if(!STATE.canEdit) return;
    STATE.editMode = true;
    // tiefe Kopie, damit Abbrechen m√∂glich
    STATE._backup = JSON.parse(JSON.stringify(STATE.schema));
    renderView();
    toggleSchemaButtons();
  }
  function cancelEdit(){
    if(!STATE.canEdit) return;
    STATE.editMode = false;
    if(STATE._backup){ STATE.schema = STATE._backup; STATE._backup=null; }
    renderView();
    toggleSchemaButtons();
  }

  $('editSchemaBtn').onclick = enterEdit;
  $('saveSchemaBtn').onclick = saveSchema;
  $('cancelSchemaBtn').onclick = cancelEdit;
  $('addDayBtn').onclick = ()=>{
    STATE.schema.slots = STATE.schema.slots || [];
    STATE.schema.slots.push({ day:'Neuer Tag', slots:[] });
    renderView();
  };

  // ---------- Schul-Auswahl (nur wenn MASTER aktiv) ----------
  async function setupSchoolPicker(){
    const sel = $('schoolSelect');
    const active = (sessionStorage.getItem('activeSchool')||'').trim();
    const base   = (sessionStorage.getItem('school')||'').trim();

    // Wenn wirklich MASTER aktiv ist, Dropdown zeigen; ansonsten ausblenden
    const isMaster = (active||base).toUpperCase()==='MASTER';
    $('schoolSelect').style.display = isMaster ? 'inline-block' : 'none';
    STATE.isMasterScope = isMaster;

    if(!isMaster) return;

    // einfache Quelle: Schulen aus Collection "Schulen" ‚Üí Doc "MASTER", Feld "School" (Array oder String)
    async function loadAccessibleSchools(key){
      try{
        const tries=[key,key?.toUpperCase(),key?.charAt(0)?.toUpperCase()+key?.slice(1)?.toLowerCase(),key?.toLowerCase()].filter(Boolean);
        for(const k of tries){
          const snap=await db.collection('Schulen').doc(k).get();
          if(snap.exists){
            const d=snap.data()||{};
            const arr = Array.isArray(d.School) ? d.School
                     : Array.isArray(d.schools) ? d.schools
                     : (typeof d.School==='string'? d.School.split(/[,\n;]+/): []);
            return (arr||[]).map(s=>String(s).trim()).filter(Boolean);
          }
        }
      }catch(e){}
      return [];
    }

    const list = await loadAccessibleSchools('MASTER');
    sel.innerHTML='';
    const mk = (v,t)=>{const o=document.createElement('option');o.value=v;o.textContent=t; return o;};
    sel.appendChild(mk('MASTER','MASTER (Bitte Schule w√§hlen)'));
    list.forEach(s=> sel.appendChild(mk(s.toLowerCase(), s)));
    sel.value = STATE.school || 'MASTER';
    sel.onchange = async ()=>{
      STATE.school = sel.value;
      sessionStorage.setItem('activeSchool', STATE.school);
      await initLoad(); // neu laden f√ºr gew√§hlte Schule
    };
  }

  // ---------- Init ----------
  async function initLoad(){
    // Rolle/Schule lesen
    const role = normalizeRole(sessionStorage.getItem('role')||'');
    let school = getActiveSchool();
    STATE.role   = role || 'user';
    STATE.school = school;
    STATE.canEdit = (role==='admin'||role==='si-fu');

    $('userRole').textContent   = STATE.role;
    $('userSchool').textContent = (STATE.school||'‚Äì');

    await setupSchoolPicker();

    if (STATE.isMasterScope && (!STATE.school || STATE.school==='master')){
      // MASTER ohne konkrete Schule ‚Üí Hinweis
      root.innerHTML = '<div class="hint">Bitte oben eine Schule w√§hlen.</div>';
      toggleSchemaButtons();
      return;
    }

    const { schema, beleg } = await loadAllForSchool(STATE.school);
    STATE.schema = schema;
    STATE.belegung = beleg;

    STATE.editMode = false;
    renderView();
    toggleSchemaButtons();
  }

  // ---------- Auth ----------
  auth.onAuthStateChanged(async user=>{
    if(!user){location.href="index.html";return;}
    try{
      // Fallback: rolle/schule ggf. aus DB laden, wenn SessionStorage leer
      let role=(sessionStorage.getItem('role')||'').trim();
      let school=(sessionStorage.getItem('school')||'').trim();
      if(!role||!school){
        const rdoc=await db.collection('rollen').doc(user.uid).get();
        if(rdoc.exists){
          const data=rdoc.data()||{};
          role = normalizeRole(data.role||'user');
          school = (data.school||'').trim();
          sessionStorage.setItem('role', role);
          sessionStorage.setItem('school', school);
        }
      }
      await initLoad();
    }catch(e){
      console.error(e);
      root.innerHTML='<div class="hint">Fehler beim Laden.</div>';
    }
  });
  </script>
</body>
</html>
