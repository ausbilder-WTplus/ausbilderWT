<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trainingstermine – Admin</title>
  <style>
    :root {
      --bg:#000; --card:#111; --border:#333; --text:#fff; --muted:#bbb;
      --ok:#4ade80; --warn:#facc15; --err:#f87171;
    }
    * { box-sizing: border-box; }
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;}

    /* HEADER */
    .header{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 16px;gap:12px;border-bottom:1px solid var(--border);
    }
    .header img{height:70px;width:auto;object-fit:contain;}
    @media(max-width:750px){.header img{height:44px;}}
    @media(max-width:480px){.header img{height:40px;}}

    .wrap{max-width:1100px;margin:0 auto;padding:16px;}
    h1{margin:12px 0 8px;}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;
           border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns: 1.1fr 1.4fr; gap:16px;}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--border);
          border-radius:12px;padding:16px;}
    label{display:block;margin:8px 0 4px}
    input,select{width:100%;padding:10px;border:1px solid var(--border);
                 border-radius:10px;background:#000;color:var(--text)}
    button{background:#fff;color:#000;border:none;border-radius:10px;
           padding:10px 14px;font-weight:bold;cursor:pointer}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1;min-width:200px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:8px 12px;
          border:1px solid var(--border);border-radius:999px;font-size:14px;
          color:var(--text);background:#0b0b0b}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}

    .qr-wrap{display:flex;flex-direction:column;gap:8px;align-items:center}
    #qr{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:16px;display:inline-block}
    #qr canvas,#qr img{background:#fff;border-radius:0;display:block;image-rendering:pixelated}
    #qrPayload{color:var(--muted);font-size:12px;word-break:break-all;text-align:center}

    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #222;text-align:left}
    tr.sel{background:#0e0e0e}
    .muted{color:var(--muted)}
    .status{margin-left:8px;font-size:14px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header" id="header">
  <img id="logo-left" src="pluslogo.png" alt="Logo links">
  <img id="logo-center" src="faust.jpg" alt="Logo Mitte">
  <img id="logo-right" src="melsungen.jpg" alt="Logo rechts">
</div>

<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <h1>Trainingstermine – Verwaltung</h1>
    <div class="badge">Rolle: <span id="roleText">–</span></div>
  </div>

  <div class="grid">
    <!-- Linke Spalte -->
    <div class="card">
      <h3>Neuen Termin anlegen</h3>
      <div class="row">
        <div>
          <label for="dt">Datum & Uhrzeit</label>
          <input type="datetime-local" id="dt" required>
        </div>
        <div>
          <label>Schule (vorgewählt)</label>
          <div id="schoolPill" class="pill">–</div>
          <input type="hidden" id="school">
        </div>
      </div>
      <label for="topic">Thema</label>
      <input type="text" id="topic" placeholder="z.B. Lat Sao – Konterserien" required>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="createBtn">Termin anlegen</button>
        <span id="status" class="status muted">Bereit</span>
      </div>

      <hr style="border-color:#222;margin:16px 0">

      <h3>Bestehende Termine</h3>
      <div class="row" style="align-items:center">
        <div>
          <label>Schule</label>
          <div id="listSchoolPill" class="pill">–</div>
        </div>
        <div>
          <label for="filterRange">Zeitraum</label>
          <select id="filterRange">
            <option value="upcoming">Kommende</option>
            <option value="past">Vergangene</option>
            <option value="all">Alle</option>
          </select>
        </div>
        <div style="min-width:120px">
          <button id="reloadBtn" class="ghost">Aktualisieren</button>
        </div>
      </div>

      <table aria-label="Terminliste">
        <thead><tr><th>Datum</th><th>Thema</th><th>Schule</th><th>Status</th></tr></thead>
        <tbody id="sessionsTbody"></tbody>
      </table>
      <div class="muted" id="listInfo" style="margin-top:6px">0 Termine</div>
    </div>

    <!-- Rechte Spalte -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div class="pill">Ausgewählte ID: <span id="sidLabel" class="mono">–</span></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="openBtn" class="ghost" disabled>Check-in öffnen</button>
          <button id="closeBtn" class="ghost" disabled>Check-in schließen</button>
          <button id="showQrBtn" class="ghost" disabled>QR anzeigen</button>
          <button id="deleteBtn" style="background:#f33;color:#fff" disabled>Löschen</button>
        </div>
      </div>

      <div class="qr-wrap" style="margin-top:12px">
        <div id="qr">(kein aktiver Check-in)</div>
        <div id="qrPayload" class="muted"></div>
      </div>

      <hr style="border-color:#222;margin:16px 0">

      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <h3>Anwesenheiten (Live)</h3>
        <div id="count" class="muted">0 Teilnehmende</div>
      </div>
      <table aria-label="Anwesenheitsliste">
        <thead><tr><th>Name</th><th>E-Mail</th><th>Uhrzeit</th></tr></thead>
        <tbody id="list"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="attendance-shared.js"></script>

<!-- QRCode Loader -->
<script>
async function ensureQRCodeLoaded(){
  if (window.QRCode && typeof QRCode.prototype.makeCode === 'function') return;
  const sources = [
    './vendor/qrcode/qrcode.min.js',
    'https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@master/qrcode.min.js'
  ];
  for (const src of sources){
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=src; s.async=true;
        s.onload=res; s.onerror=()=>rej();
        document.head.appendChild(s);
      });
      if (window.QRCode && typeof QRCode.prototype.makeCode === 'function') return;
    }catch{}
  }
  throw new Error('QRCode-Bibliothek konnte nicht geladen werden.');
}
</script>

<!-- HEADER LOGIK -->
<script>
if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

function preloadAndSet(imgEl, url) {
  const test = new Image();
  test.onload = () => { imgEl.src = url; };
  test.onerror = () => {};
  test.src = url;
}

auth.onAuthStateChanged(async (user) => {
  if (!user) { location.href = "index.html"; return; }

  try {
    let activeSchool = (sessionStorage.getItem('activeSchool') || '').trim().toLowerCase();
    let baseSchool   = (sessionStorage.getItem('school') || '').trim().toLowerCase();
    if (!activeSchool && !baseSchool) {
      const snap = await db.collection('rollen').doc(user.uid).get();
      if (snap.exists) {
        const data = snap.data();
        baseSchool = (data.school || '').toLowerCase();
        sessionStorage.setItem('school', baseSchool);
      }
    }
    const school = activeSchool || baseSchool || 'master';
    if (school !== 'master') {
      const base = `logos/${school}`;
      preloadAndSet(document.getElementById('logo-left'), `${base}/logo-left.jpg`);
      preloadAndSet(document.getElementById('logo-center'), `${base}/logo-center.jpg`);
      preloadAndSet(document.getElementById('logo-right'), `${base}/logo-right.jpg`);
    }
  } catch (e) {
    console.error('[Header/School]', e);
  }
});
</script>

<!-- Hauptlogik (unverändert) -->
<script>
(async function(){
  const {auth,db,newNonce,buildQrPayload,getUserRole} = window._att || {};
  if (!auth || !db) { alert('Firebase nicht initialisiert.'); location.replace('index.html'); return; }
  await new Promise(r => auth.onAuthStateChanged(u => { if(!u){ alert('Nicht eingeloggt.'); location.replace('index.html'); } else r(); }));

  try { await ensureQRCodeLoaded(); }
  catch(e){ alert('QR-Code Bibliothek fehlt.'); return; }

  const ACTIVE_SCHOOL = ((sessionStorage.getItem('activeSchool') || sessionStorage.getItem('school') || '') + '').trim().toUpperCase();
  if (!ACTIVE_SCHOOL) {
    alert('Keine Schule gewählt. Bitte zuerst auf der Hauptseite Schule auswählen.');
    location.replace('hauptseite.html'); return;
  }

  // ... dein kompletter bisheriger Script-Inhalt bleibt unverändert ...
})();
</script>
</body>
</html>
