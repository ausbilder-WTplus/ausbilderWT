<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WT-Ausbilder ‚Äì Protokollansicht</title>
  <style>
    :root { --bg:#000; --text:#fff; --accent-bg:#fff; --accent-text:#000; --card:#111; --border:#333; --muted:#aaa; --hover:#1a1a1a; }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border)}
    header img{height:60px;object-fit:contain;transition:opacity .3s ease;}
    .content{max-width:1100px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}
    .btn{background:var(--accent-bg);color:var(--accent-text);border:none;padding:10px 16px;border-radius:10px;font-weight:bold;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3);}
    .btn.small{font-size:13px;padding:8px 12px;border-radius:8px}
    .pill{background:#0b0b0b;color:#fff;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:14px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
    input, select{width:100%;background:#000;color:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px}
    .status{display:block;text-align:center;margin-top:4px;font-size:14px;color:var(--muted)}
    .status.ok{color:#9be79b} .status.err{color:#ff9c9c}

    /* Read-only Topics */
    .topic-card{background:#0b0b0b;border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .topic-title{font-weight:bold}
    .topic-meta{font-size:13px;color:var(--muted)}
    .topic-notes{white-space:pre-wrap;line-height:1.35}

    .list{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .list .item{display:flex;align-items:center;gap:8px}

    .home-btn{position:fixed; left:18px; bottom:18px; border:none; background:#fff; color:#000; border-radius:50%; padding:10px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.35); z-index:1000;}
    .home-btn img{ width:32px; height:32px; display:block; }

    .inline-check{display:inline-flex;align-items:center;gap:8px;margin:0;padding:0;line-height:1}
    .inline-check input[type="checkbox"]{width:auto;height:auto;margin:0;transform:none}

    .print-summary{display:none;margin-top:-4px;margin-bottom:8px}
    .print-summary h2{font-size:20px;margin-bottom:6px;color:#000}
    .print-summary .row{gap:10px}
    .print-summary .box{padding:10px;border:1px solid #ddd;border-radius:8px;background:#fff;color:#000}

    /* Bildschirm: Rolle & "Training manuell w√§hlen" ausblenden */
    #activeRolePill, #manualRow { display:none !important; }

    /* Druck-Ansicht */
    @media print {
      body { background:#fff; color:#000; }
      header, .home-btn, .btn, #controlsRow, #manualRow { display:none !important; }
      .card, .topic-card { background:#fff !important; border:none !important; box-shadow:none !important; }
      input, select { background:#fff !important; color:#000 !important; border:none !important; }
      .pill { border:none !important; background:#fff !important; color:#000 !important; }
      .print-summary{ display:block !important; }
    }
  </style>
</head>
<body>
<header>
  <img id="logo-left" src="logos/master/logo-left.jpg" alt="Logo links">
  <img id="logo-center" src="logos/master/logo-center.jpg" alt="Logo Mitte">
  <img id="logo-right" src="logos/master/logo-right.jpg" alt="Logo rechts">
</header>

<div class="content" id="app" style="display:none">
  <!-- Print-Zusammenfassung (nur im Druck sichtbar) -->
  <div class="print-summary" id="printSummary">
    <h2>Ausbildertraining</h2>
    <div class="row">
      <div class="box" style="flex:1"><strong>Termin:</strong> <span id="printDate">‚Äî</span></div>
      <div class="box" style="flex:2"><strong>Thema:</strong> <span id="printTopic">‚Äî</span></div>
    </div>
  </div>

  <!-- Kopf: Terminwahl (Screen) -->
  <div class="card">
    <div id="controlsRow" class="row" style="align-items:center">
      <div>
        <label>Trainingstermin</label>
        <select id="sessionDateSelect"><option value="">(Lade Termine‚Ä¶)</option></select>
      </div>
      <div>
        <label>Trainingsthema</label>
        <input id="topicFromDb" disabled placeholder="Wird geladen‚Ä¶" />
      </div>
      <div style="flex:0 0 auto; display:flex; gap:8px; align-items:center">
        <button class="btn small" id="reloadSessionsBtn">üîÑ Termine neu laden</button>
      </div>
    </div>

    <!-- Manuelle Wahl ‚Äì auf dieser View komplett ausgeblendet -->
    <div id="manualRow" class="row" style="align-items:center; margin-top:10px">
      <label class="inline-check">
        <input type="checkbox" id="manualSessionToggle" />
        <span>Training manuell w√§hlen</span>
      </label>
      <div id="manualDateWrap" style="display:none">
        <label>Manuelles Datum</label>
        <input type="date" id="manualDateInput" />
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <span id="activeRolePill" class="pill"></span>
      <span id="activeSchoolPill" class="pill" style="display:none"></span>
    </div>
  </div>

  <!-- Live Anwesenheit (read-only) -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3>üë• Live-Anwesenheit</h3>
      <div class="row" style="flex:0 0 auto">
        <span class="pill" id="attCountPill">0</span>
      </div>
    </div>
    <div id="attendanceList" class="list" aria-live="polite"></div>
  </div>

  <!-- Protokoll-Inhalt: Themen & Notizen -->
  <div class="card">
    <h3 style="margin-bottom:8px">üìù Themen & Notizen</h3>
    <div id="topicsWrap" style="display:grid;gap:12px"></div>
    <div id="noTopicsHint" class="status" style="display:none">Keine Themen vorhanden.</div>
  </div>

  <!-- To-Dos -->
  <div class="card">
    <h3 style="margin-bottom:8px">üìå To-Dos</h3>
    <div id="todoList" class="readonly" style="gap:8px"></div>
    <div id="noTodosHint" class="status" style="display:none">Keine To-Dos vorhanden.</div>
  </div>

  <!-- Drucken & Gelesen-Ack -->
  <div class="card" id="footerActions">
    <div class="row" style="align-items:center">
      <label class="inline-check" style="flex:1">
        <input type="checkbox" id="ackCheckbox" />
        <span>Protokoll gelesen</span>
      </label>
      <button class="btn" id="printBtn">üñ®Ô∏è Drucken</button>
    </div>
    <span id="ackInfo" class="status" aria-live="polite">‚Äî</span>
  </div>
</div>

<!-- Home-Button -->
<button class="home-btn" onclick="location.href='hauptseite.html'">
  <img src="home.jpg" alt="Home">
</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script>
if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

/* Helpers */
function preloadAndSet(img, url){const t=new Image();t.onload=()=>img.src=url; t.src=url;}
async function applyHeaderBySchool(school){
  const base=(school&&school.toLowerCase()!=='master')?`logos/${school.toLowerCase()}`:'logos/master';
  preloadAndSet(document.getElementById('logo-left'),`${base}/logo-left.jpg`);
  preloadAndSet(document.getElementById('logo-center'),`${base}/logo-center.jpg`);
  preloadAndSet(document.getElementById('logo-right'),`${base}/logo-right.jpg`);
}
const normalize=r=>{r=(r||'').toLowerCase();
  if(['administrator','admins','adminstrator'].includes(r))r='admin';
  if(['trainer/in','trainerin','coach'].includes(r))r='trainer';
  if(['si-fu','sifu','si fu','si‚Äêfu','si‚Äífu'].includes(r))r='si-fu';
  return r;
};
function ymd(d){const z=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}
function todayLocal(){const d=new Date(); d.setHours(0,0,0,0); return d;}
function startOfDay(d){const x=new Date(d);x.setHours(0,0,0,0);return x}
function endOfDay(d){const x=new Date(d);x.setHours(23,59,59,999);return x}
function nextMonday001(base=new Date()){
  const d=new Date(base); const day=(d.getDay()+6)%7; // Mo=0
  const next=new Date(d); next.setDate(d.getDate() + (7 - day));
  next.setHours(0,1,0,0);
  return next;
}
function protocolDocRef(schoolLower, dateKey){
  return db.collection('protocols').doc(schoolLower).collection('dates').doc(dateKey);
}

/* App State */
const state={school:null, role:null, currentSessionId:null, topicDb:'‚Äî', att:[]};

/* ======= Auth ======= */
auth.onAuthStateChanged(async user=>{
  if(!user){location.replace('index.html');return;}
  document.getElementById('app').style.display='block';

  let role=normalize(sessionStorage.getItem('role')),
      school=(sessionStorage.getItem('school')||'').trim();
  if(!role||!school){
    try{const p=await db.collection('rollen').doc(user.uid).get();
      if(p.exists){const d=p.data(); role=normalize(d.role); school=(d.school||'').trim();
        sessionStorage.setItem('role',role); sessionStorage.setItem('school',school);
      }}catch{}
  }
  const active=(sessionStorage.getItem('activeSchool')||school||'MASTER').trim().toUpperCase();
  state.role=role; state.school=active;

  const schoolPill=document.getElementById('activeSchoolPill');
  schoolPill.textContent='Schule: '+state.school;
  schoolPill.style.display='inline-block';

  await applyHeaderBySchool(state.school);

  initPage().catch(e=>console.error('[init]',e));
});

/* ======= Default: letzter stattgefundener Trainingstag / letztes vorhandenes Protokoll ======= */
async function findLatestProtocolDateKeyUpToToday(schoolUpper) {
  const schoolLower = (schoolUpper || '').toLowerCase();
  const todayKey = ymd(todayLocal());
  try {
    const ref = db.collection('protocols').doc(schoolLower).collection('dates');
    const snap = await ref
      .orderBy(firebase.firestore.FieldPath.documentId())
      .endAt(todayKey)
      .limitToLast(1)
      .get();
    if (!snap.empty) return snap.docs[0].id;
  } catch(e) {
    console.warn('[latestProtocol]', e);
  }
  return null;
}

/* ======= Sessions laden / Auswahl ======= */
async function loadAllSessionsForSchool(){
  const sel=document.getElementById('sessionDateSelect');
  sel.innerHTML='<option value="">(Lade Termine‚Ä¶)</option>';
  try{
    let snap=null;
    try{
      snap = await db.collection('sessions')
        .where('school','==',state.school)
        .orderBy('date','asc')
        .limit(400)
        .get();
    }catch(e){
      const s2 = await db.collection('sessions').where('school','==',state.school).get();
      const rows=[]; s2.forEach(doc=>{ const d=doc.data(); const dt=d.date?.toDate?.(); if(!dt) return; rows.push({id:doc.id, data:d, dt}); });
      rows.sort((a,b)=>a.dt-b.dt);
      snap = { docs: rows.map(r=>({ id:r.id, data:()=>r.data })) };
    }

    const byDay=new Map();
    snap.docs.forEach(doc=>{
      const data=doc.data(); const dt=data.date?.toDate?.(); if(!dt) return;
      const key=ymd(dt);
      if(!byDay.has(key)){
        byDay.set(key, { sessionId: doc.id, date: dt, topic: data.topic||'' });
      }
    });

    const items=[...byDay.entries()].map(([key,val])=>({key, ...val})).sort((a,b)=>a.date - b.date);
    sel.innerHTML='';
    if(items.length===0){
      sel.innerHTML='<option value="">(Keine Termine gefunden)</option>';
      sel.disabled=true; 
      await applySelectedSessionFromPicker(); 
      return;
    }

    const nowMs = todayLocal().getTime();
    let defaultIdx = -1;

    const latestProtoKey = await findLatestProtocolDateKeyUpToToday(state.school);
    if (latestProtoKey) {
      defaultIdx = items.findIndex(x => x.key === latestProtoKey);
    }
    if (defaultIdx === -1) {
      // letzter vergangener Termin
      defaultIdx = items.reduce((acc, it, idx) => (it.date.getTime() <= nowMs ? idx : acc), -1);
    }
    if (defaultIdx === -1) {
      // sonst n√§chster kommender
      defaultIdx = items.findIndex(x => x.date.getTime() >= nowMs);
    }
    if (defaultIdx === -1) defaultIdx = items.length - 1;

    items.forEach((it,idx)=>{
      const op=document.createElement('option');
      op.value=it.key;
      op.textContent = `${it.date.toLocaleString()}${it.topic?' ‚Äî '+it.topic:''}`;
      op.dataset.sessionId = it.sessionId;
      sel.appendChild(op);
      if(idx===defaultIdx) sel.selectedIndex=idx;
    });

    await applySelectedSessionFromPicker();
  }catch(e){
    console.error('[loadAllSessionsForSchool]', e);
    sel.innerHTML='<option value="">(Fehler beim Laden)</option>';
    sel.disabled=true;
    await applySelectedSessionFromPicker();
  }
}

function getSelectedDate(){
  const sel=document.getElementById('sessionDateSelect');
  const v=sel.value; if(!v){ return todayLocal(); }
  const [y,m,da]=v.split('-').map(n=>parseInt(n,10));
  return new Date(y, m-1, da, 0,0,0,0);
}
function getSelectedDateKey(){ return ymd(getSelectedDate()); }

/* ======= Gelesen-H√§kchen ‚Äì Datenpfade =======
   Neu: protocols/{schoolLower}/read/{dateKey}/byEmail/{email}
   Legacy (optional): users/{uid}/protocolAcks/{schoolLower}_{dateKey}
*/
function readAckDocRef_ByNewStructure(emailRaw, schoolUpper, dateKey){
  const schoolLower=(schoolUpper||'').toLowerCase();
  return db.collection('protocols')
    .doc(schoolLower)
    .collection('read')
    .doc(dateKey)
    .collection('byEmail')
    .doc(emailRaw); // E-Mail exakt wie auth.email (case-sensitiv)
}
function ackDocRef_legacy(uid, schoolUpper, dateKey){
  const key = `${(schoolUpper||'').toLowerCase()}_${dateKey}`;
  return db.collection('users').doc(uid).collection('protocolAcks').doc(key);
}

/* ======= Gelesen-H√§kchen ‚Äì UI & Logik ======= */
async function refreshAckUI(){
  const user = auth.currentUser; if(!user) return;
  const cb=document.getElementById('ackCheckbox');
  const info=document.getElementById('ackInfo');
  const email=(user.email||'').trim(); // wichtig: kein toLowerCase()
  const ref=readAckDocRef_ByNewStructure(email, state.school, getSelectedDateKey());
  try{
    const snap=await ref.get();
    let checked=false, expires=null;
    if(snap.exists){
      const d=snap.data()||{};
      expires = d.expiresAt?.toDate?.() || null;
      if(!expires || new Date() < expires) checked=!!d.read;
    }
    cb.checked=checked;
    info.textContent = checked
      ? (expires ? `Gelesen (g√ºltig bis ${expires.toLocaleString()})` : 'Gelesen')
      : 'Noch nicht best√§tigt';
    info.className = 'status ' + (checked ? 'ok' : 'err');
  }catch(e){
    console.error('[ack] read error', e);
    cb.checked=false;
    info.textContent = (e?.code === 'permission-denied')
      ? 'Keine Berechtigung, bitte Firestore-Regeln pr√ºfen.'
      : 'Status unbekannt';
    info.className='status';
  }
}

async function saveAck(checked){
  const user = auth.currentUser; if(!user) return;
  const email=(user.email||'').trim();
  const dateKey=getSelectedDateKey();
  const schoolUpper=state.school;

  const refNew = readAckDocRef_ByNewStructure(email, schoolUpper, dateKey);
  const refLegacy = ackDocRef_legacy(user.uid, schoolUpper, dateKey); // optional

  if(checked){
    const expires=nextMonday001(new Date()); // n√§chste Woche Mo 00:01
    const payload={
      read:true,
      school:schoolUpper,
      dateKey,
      email,
      setAt:firebase.firestore.FieldValue.serverTimestamp?.() || new Date(),
      expiresAt: firebase.firestore.Timestamp.fromDate(expires)
    };
    await refNew.set(payload, { merge:true });
    await refLegacy.set(payload, { merge:true }).catch(()=>{}); // optional
  }else{
    await refNew.delete().catch(()=>{});
    await refLegacy.delete().catch(()=>{}); // optional
  }
  await refreshAckUI();
}

/* ======= Auswahl / Rendering ======= */
async function applySelectedSessionFromPicker(){
  document.getElementById('topicFromDb').value='Lade‚Ä¶';
  state.currentSessionId=null; state.topicDb='‚Äî';
  const hit=await findSessionForDate(getSelectedDate(), state.school);
  if(hit){ state.currentSessionId=hit.id; state.topicDb=hit.data.topic||'‚Äî'; }
  document.getElementById('topicFromDb').value=state.topicDb||'‚Äî';

  updatePrintSummary();
  startAttendanceListener();
  await loadProtocolView();
  await refreshAckUI();
}

async function findSessionForDate(date, school){
  const start=startOfDay(date), end=endOfDay(date);
  try{
    const s=await db.collection('sessions')
      .where('school','==',school)
      .where('date','>=',firebase.firestore.Timestamp.fromDate(start))
      .where('date','<=',firebase.firestore.Timestamp.fromDate(end))
      .orderBy('date','asc')
      .limit(3)
      .get();
    if(!s.empty){const doc=s.docs[0]; return {id:doc.id, data:doc.data()};}
  }catch(e){ }
  try{
    const s2=await db.collection('sessions').where('school','==',school).limit(200).get();
    let best=null; s2.forEach(doc=>{const d=doc.data(); const dt=d.date?.toDate?.(); if(!dt) return; if(ymd(dt)===ymd(date)) best={id:doc.id, data:d};});
    if(best) return best;
  }catch(e){ }
  return null;
}

/* Live-Anwesenheit (read-only) */
let unsubAtt=null;
function dedupeBy(arr,keyFn){const seen=new Set(); const out=[]; for(const x of arr){const k=keyFn(x); if(seen.has(k)) continue; seen.add(k); out.push(x);} return out;}
function renderAttendance(){
  const wrap=document.getElementById('attendanceList'); wrap.innerHTML='';
  const list=state.att||[]; document.getElementById('attCountPill').textContent=list.length;
  if(list.length===0){ wrap.innerHTML='<span class="status">Keine Check-Ins.</span>'; return; }
  list.forEach(p=>{
    const left=document.createElement('div'); left.className='item';
    left.appendChild(document.createTextNode('‚Ä¢ '));
    const name=document.createElement('span'); name.textContent = p.name||'Unbekannt';
    left.appendChild(name);
    const right=document.createElement('div'); right.innerHTML='';
    wrap.appendChild(left); wrap.appendChild(right);
  });
}
function startAttendanceListener(){
  if(typeof unsubAtt==='function'){ try{unsubAtt();}catch{} }
  state.att=[];
  if(!state.currentSessionId){ renderAttendance(); return; }
  try{
    unsubAtt=db.collection('sessions').doc(state.currentSessionId).collection('checkins')
      .orderBy('checkedAt','desc')
      .onSnapshot(s=>{
        const list=[]; s.forEach(doc=>{const d=doc.data()||{}; list.push({name:d.displayName||d.name||'Unbekannt', uid:d.uid||doc.id});});
        state.att=dedupeBy(list,p=>p.uid||p.name); renderAttendance();
      });
  }catch(e){ renderAttendance(); }
}

/* Protokoll laden & rendern (read-only) */
async function loadProtocolView(){
  const schoolLower = state.school.toLowerCase();
  const dateKey = getSelectedDateKey();
  const topWrap=document.getElementById('topicsWrap');
  const todoWrap=document.getElementById('todoList');
  document.getElementById('noTopicsHint').style.display='none';
  document.getElementById('noTodosHint').style.display='none';
  topWrap.innerHTML=''; todoWrap.innerHTML='';

  try{
    const snap=await protocolDocRef(schoolLower, dateKey).get();
    if(!snap.exists){
      document.getElementById('noTopicsHint').style.display='block';
      document.getElementById('noTodosHint').style.display='block';
      return;
    }
    const d=snap.data()||{};
    const topics = Array.isArray(d.topics)? d.topics : [];
    const todos  = Array.isArray(d.todos)?  d.todos  : [];

    if(topics.length===0){
      document.getElementById('noTopicsHint').style.display='block';
    } else {
      topics.forEach(t=>{
        const card=document.createElement('div'); card.className='topic-card';
        const title=document.createElement('div'); title.className='topic-title'; title.textContent=t.title||'‚Äì';
        const meta=document.createElement('div'); meta.className='topic-meta'; meta.textContent = (t.owner? `Verantwortlich: ${t.owner}` : 'Verantwortlich: ‚Äì');
        const notes=document.createElement('div'); notes.className='topic-notes'; notes.textContent=t.notes||'';
        card.appendChild(title); card.appendChild(meta); card.appendChild(notes);
        topWrap.appendChild(card);
      });
    }

    if(todos.length===0){
      document.getElementById('noTodosHint').style.display='block';
    } else {
      todos.forEach(td=>{
        const row=document.createElement('div'); row.className='row' ; row.style.alignItems='center';
        const bullet=document.createElement('span'); bullet.textContent='‚Ä¢'; bullet.style.flex='0 0 auto';
        const text=document.createElement('span'); text.style.flex='1'; text.textContent=td.task||'‚Äì';
        const owner=document.createElement('span'); owner.style.flex='0 0 auto'; owner.style.color='var(--muted)';
        owner.textContent=td.owner? `(${td.owner})` : '(‚Äì)';
        row.appendChild(bullet); row.appendChild(text); row.appendChild(owner);
        todoWrap.appendChild(row);
      });
    }
  }catch(e){
    console.error('[protocolView] load error', e);
    document.getElementById('noTopicsHint').textContent='Fehler beim Laden.';
    document.getElementById('noTopicsHint').style.display='block';
  }
}

/* Print summary helper */
function updatePrintSummary(){
  const dateKey = getSelectedDateKey();
  const [y,m,d]=dateKey.split('-').map(n=>parseInt(n,10));
  const dispDate=new Date(y, m-1, d).toLocaleString();
  const topic=(document.getElementById('topicFromDb').value||'‚Äî');
  document.getElementById('printDate').textContent = dispDate;
  document.getElementById('printTopic').textContent = topic && topic.trim() ? topic : '‚Äî';
}

/* Init */
async function initPage(){
  document.getElementById('printBtn').onclick=()=>window.print();
  document.getElementById('sessionDateSelect').addEventListener('change', ()=>{
    applySelectedSessionFromPicker();
  });
  document.getElementById('reloadSessionsBtn').onclick=()=>loadAllSessionsForSchool();

  // Checkbox-Handler (neue Struktur speichern)
  document.getElementById('ackCheckbox').addEventListener('change', (e)=>{
    saveAck(e.target.checked).catch(console.error);
  });

  await loadAllSessionsForSchool();
}
</script>
</body>
</html>
