<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrierung</title>
  <style>
    :root { --bg:#000; --text:#fff; --card:#111; --border:#2a2a2a; --ok:#2ecc71; --err:#ff6b6b; }
    * { box-sizing:border-box; }
    body { margin:0; background:#000; color:#fff; font-family:Arial, Helvetica, sans-serif;
           min-height:100vh; display:flex; flex-direction:column; }
    .header{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; gap:12px; }
    .header img{ height:80px; width:auto; object-fit:contain; }
    @media (max-width:750px){ .header img{ height:44px; } }
    @media (max-width:480px){ .header img{ height:40px; } }
    .wrap{ flex:1; display:flex; flex-direction:column; align-items:center; padding:16px; }
    .card{ width:100%; max-width:680px; background:#111; border:1px solid var(--border);
           border-radius:12px; padding:16px; box-shadow:0 4px 16px rgba(0,0,0,.35); }
    h1{ margin:0 0 12px; font-size:24px; }
    .row{ display:flex; gap:12px; align-items:center; margin:10px 0; }
    .row label{ min-width:120px; }
    .input, .select{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid #333; background:#000; color:#fff; font-size:16px; }
    .select:disabled{ opacity:.7; }
    .btn{ background:#fff; color:#000; border:none; border-radius:12px; padding:10px 18px; font-size:16px;
          cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.35); }
    .btn[disabled]{ opacity:.6; cursor:default; }
    .msg{ margin-top:10px; font-size:14px; }
    .ok{ color:var(--ok); } .err{ color:var(--err); }
    .home-btn{ position:fixed; left:18px; bottom:18px; border:none; background:#fff; color:#000;
               border-radius:50%; padding:10px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.35); }
    .home-btn img{ width:32px; height:32px; display:block; }
  </style>
</head>
<body>
  <div class="header">
    <img src="pluslogo.jpg" alt="Logo links">
    <img src="faust.jpg" alt="Logo Mitte">
    <img src="Ewto.jpg" alt="Logo rechts">
  </div>

  <div class="wrap">
    <div class="card">
      <h1>Registrierung</h1>

      <div class="row">
        <label for="email">E-Mail</label>
        <input id="email" type="email" class="input" autocomplete="email" required />
      </div>

      <div class="row">
        <label for="pass">Passwort</label>
        <input id="pass" type="password" class="input" autocomplete="new-password" required />
      </div>

      <div class="row">
        <label for="role">Rolle</label>
        <select id="role" class="select">
          <option value="Admin">Admin</option>
          <option value="Si-Fu">Si-Fu</option>
          <option value="Trainer" selected>Trainer</option>
        </select>
      </div>

      <div class="row">
        <label for="school">Schule</label>
        <!-- Optionen werden dynamisch geladen -->
        <select id="school" class="select">
          <option disabled selected>Lade verfügbare Schulen…</option>
        </select>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="registerBtn" class="btn">Registrieren</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <button class="home-btn" onclick="location.href='hauptseite.html'">
    <img src="home.jpg" alt="Home">
  </button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <!-- Zentrale Firebase-Config -->
  <script src="firebase-config.js"></script>

  <script>
    /* ---------- Firebase Init (zentral) ---------- */
    if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    const rtdb = firebase.database();
    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

    /* ---------- Helpers ---------- */
    const $ = s => document.querySelector(s);
    const setMsg = (t, ok=false) => { const el = $("#msg"); el.textContent=t; el.className = "msg " + (ok?"ok":"err"); };

    function roleTitleCase(role){
      role = (role||"").toLowerCase();
      if (role === "si-fu") return "Si-Fu";
      if (role === "admin") return "Admin";
      if (role === "trainer") return "Trainer";
      return role.charAt(0).toUpperCase() + role.slice(1);
    }

    const normalize = r => {
      r=(r||"").toLowerCase();
      if(['administrator','admins','adminstrator'].includes(r)) r='admin';
      if(['trainer/in','trainerin','coach'].includes(r)) r='trainer';
      if(['si-fu','sifu','si fu','si‐fu','si‒fu'].includes(r)) r='si-fu';
      return r;
    };

    function splitSchoolsString(str){
      if (!str) return [];
      return String(str).split(/[,\n;]+/).map(s=>s.trim()).filter(Boolean);
    }

    async function loadAccessibleSchools(key){
      // probiere MASTER, master, Master etc.
      const tries = [key, String(key).toUpperCase(), key.charAt(0).toUpperCase()+key.slice(1)];
      for (const k of tries){
        try{
          const snap = await db.collection('Schulen').doc(k).get();
          if (snap.exists){
            const d = snap.data()||{};
            if (Array.isArray(d.School)) return d.School.map(String).map(s=>s.trim()).filter(Boolean);
            if (typeof d.School === 'string') return splitSchoolsString(d.School);
            if (Array.isArray(d.schools)) return d.schools.map(String).map(s=>s.trim()).filter(Boolean);
            if (typeof d.schools === 'string') return splitSchoolsString(d.schools);
            return [];
          }
        }catch(e){
          console.warn('loadAccessibleSchools error', k, e);
        }
      }
      return [];
    }

    /* ---------- Schul-Select dynamisch befüllen ---------- */
    let currentSchool = "";
    auth.onAuthStateChanged(async user => {
      if (!user) { location.href = "index.html"; return; }

      // eigene Rolle/Schule laden (aus Session oder Firestore)
      let role   = normalize(sessionStorage.getItem('role'));
      currentSchool = (sessionStorage.getItem('school') || '').trim();

      if (!role || !currentSchool){
        try {
          const snap = await db.collection("rollen").doc(user.uid).get();
          if (snap.exists) {
            const data = snap.data();
            role = normalize(data.role || 'user');
            currentSchool = (data.school || '').trim();
            sessionStorage.setItem('role', role);
            sessionStorage.setItem('school', currentSchool);
            sessionStorage.setItem('loggedInUser', user.email || '');
          }
        } catch {}
      }

      const schoolSel = $("#school");
      schoolSel.innerHTML = '<option disabled selected>Lade verfügbare Schulen…</option>';

      const upper = (currentSchool || '').toUpperCase();
      let list = [];

      if (upper === 'MASTER') {
        // MASTER darf alles sehen → Schulen/MASTER
        list = await loadAccessibleSchools('MASTER');
        // Optional: auch "MASTER" selbst anbieten (z.B. für neue Master-Accounts)
        const optM = document.createElement('option');
        optM.value = 'MASTER'; optM.textContent = 'MASTER';
        schoolSel.appendChild(optM);
      } else {
        // Gruppen-Schule? (z.B. Degenhardt) → Schulen/Degenhardt
        list = await loadAccessibleSchools(currentSchool);
      }

      if (list.length > 0) {
        list.forEach(name => {
          const o = document.createElement('option');
          o.value = name; o.textContent = name;
          schoolSel.appendChild(o);
        });
        // Vorauswahl: wenn MASTER, bleib auf MASTER; sonst auf erste Schule
        if (upper === 'MASTER') {
          schoolSel.value = 'MASTER';
        } else {
          schoolSel.value = list[0];
        }
        schoolSel.disabled = false;
      } else {
        // keine Liste -> Einzelschule (oder Daten fehlen) → fixieren & sperren
        const only = currentSchool || 'MASTER';
        schoolSel.innerHTML = '';
        const o = document.createElement('option');
        o.value = only; o.textContent = only;
        schoolSel.appendChild(o);
        schoolSel.value = only;
        schoolSel.disabled = upper !== 'MASTER'; // MASTER ohne Liste bleibt wählbar, sonst gesperrt
      }
    });

    /* ---------- Registrierung ---------- */
    $("#registerBtn").addEventListener("click", async ()=>{
      const email = $("#email").value.trim();
      const pass  = $("#pass").value;
      let role    = $("#role").value.toLowerCase();
      let school  = $("#school").value; // kommt aus dynamischer Liste

      if (!email || !pass) { setMsg("Bitte E-Mail und Passwort eingeben."); return; }

      // Falls aktueller Nutzer keine MASTER-/Gruppen-Rechte hat, Schule auf eigene Schule fixieren
      if (currentSchool && currentSchool.toUpperCase() !== "MASTER") {
        const maybeGroupList = await loadAccessibleSchools(currentSchool);
        if (maybeGroupList.length === 0) {
          // echte Einzelschule → überschreibe gewählte Schule sicherheitshalber
          school = currentSchool;
        }
      }

      const btn = $("#registerBtn");
      btn.disabled = true;
      setMsg("Erstelle Benutzer…", true);

      const secondaryName = "secondary-" + Date.now();
      let secondaryApp = null;

      try {
        // sekundäre App, damit du eingeloggt bleibst
        secondaryApp = firebase.initializeApp(window.firebaseConfig, secondaryName);
        const secAuth = secondaryApp.auth();

        // 1) User anlegen
        const cred = await secAuth.createUserWithEmailAndPassword(email, pass);
        const newUid = cred.user.uid;

        // 2) Firestore-Rolle schreiben
        await db.collection("rollen").doc(newUid).set({ role, school });

        // 3) Erfolg SOFORT zeigen
        setMsg("✅ Nutzer registriert (Auth + Firestore).", true);

        // 4) Realtime-DB (optional, ohne UI-Block)
        (async () => {
          try {
            const rtdbValue = `'${roleTitleCase(role)},${school}'`;
            const rtdbWrite = rtdb.ref("logintest_Kopie/" + newUid).set(rtdbValue);
            const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error("rtdb-timeout")), 3000));
            await Promise.race([rtdbWrite, timeout]);
          } catch (e) {
            console.warn("RTDB übersprungen:", e?.message || e);
          }
        })();

        // 5) Formular zurücksetzen
        $("#email").value = "";
        $("#pass").value = "";
        $("#role").value = "Trainer";

      } catch (err) {
        console.error(err);
        let human = "Registrierung fehlgeschlagen.";
        if (err.code === "auth/email-already-in-use") human = "Diese E-Mail wird bereits verwendet.";
        else if (err.code === "auth/invalid-email")   human = "E-Mail-Adresse ist ungültig.";
        else if (err.code === "auth/weak-password")   human = "Passwort ist zu schwach.";
        else if (String(err).includes("Permission"))  human = "Keine Berechtigung (Regeln prüfen).";
        setMsg("❌ " + human);
      } finally {
        if (secondaryApp) { secondaryApp.delete().catch(()=>{}); }
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
