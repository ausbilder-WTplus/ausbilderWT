<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Videos</title>
  <style>
    :root{--bg:#000;--text:#fff}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:22px;margin:0 0 12px}
    .frame{width:100%;height:78vh;border:0;border-radius:10px;background:#111}
    .note{opacity:.8;font-size:14px;margin-top:8px}
    .err{color:#ff9c9c}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 id="title">Videos</h1>
    <iframe id="videosFrame" class="frame" title="Videos"></iframe>
    <div id="msg" class="note"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <!-- deine zentrale Config -->
  <script src="firebase-config.js"></script>

  <script>
    // --- Firebase init ---
    if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

    const frame = document.getElementById('videosFrame');
    const title = document.getElementById('title');
    const msgEl = document.getElementById('msg');

    // Varianten einer Doc-ID (robust gegen Groß-/Kleinschreibung)
    function variantsForDocId(base){
      if (!base) return [];
      const b = String(base).trim();
      const cap = b.charAt(0).toUpperCase()+b.slice(1);
      return [b, b.toUpperCase(), b.toLowerCase(), cap];
    }

    // Drive-URL → einbettbare URL
    function toEmbedUrl(url){
      if (!url) return '';
      if (url.includes('embeddedfolderview')) return url;

      // Ordner-URL -> embeddedfolderview
      const folderMatch = url.match(/drive\.google\.com\/drive\/(?:u\/\d+\/)?folders\/([a-zA-Z0-9_-]+)/);
      if (folderMatch) return `https://drive.google.com/embeddedfolderview?id=${folderMatch[1]}#grid`;

      // Datei-URL -> preview
      const fileMatch = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (fileMatch) return `https://drive.google.com/file/d/${fileMatch[1]}/preview`;

      // Sonst unverändert
      return url;
    }

    // Link (z. B. "videos") aus /links/{school} holen (ohne MASTER-Fallback)
    async function loadLinkForSchool(kind, school){
      const tries = [...new Set(variantsForDocId(school))];
      for (const id of tries){
        try{
          const snap = await db.collection('links').doc(id).get();
          if (snap.exists){
            const data = snap.data() || {};
            if (data && data[kind]) return { url: data[kind], docId: id };
          }
        }catch(e){ console.warn('read links/', id, e); }
      }
      return null;
    }

    // Start
    auth.onAuthStateChanged(async user=>{
      if(!user){ location.replace('index.html'); return; }

      // aktive Schule aus deiner Hauptseite/Session
      const active = (sessionStorage.getItem('activeSchool')
                   || sessionStorage.getItem('school')
                   || 'MASTER').trim();

      title.textContent = `Videos – ${active.toUpperCase()}`;

      // MASTER zeigt nichts: erst auf der Hauptseite eine Schule wählen
      if (active.toUpperCase() === 'MASTER') {
        frame.style.display = 'none';
        msgEl.innerHTML = '<span>Bitte zuerst auf der Hauptseite eine Schule auswählen.</span>';
        return;
      }

      const res = await loadLinkForSchool('videos', active);
      if (!res || !res.url){
        frame.style.display = 'none';
        msgEl.innerHTML = `<span class="err">Kein Video-Link für <b>${active}</b> gefunden.</span><br>
                           Lege in <code>links/${active}</code> das Feld <code>videos</code> an.`;
        return;
      }

      frame.src = toEmbedUrl(res.url);
      msgEl.textContent = `Quelle: links/${res.docId} (Feld "videos")`;
    });
  </script>
</body>
</html>
